<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoV Commander v3.5 (Macro Économique)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #3b82f6; cursor: pointer; margin-top: -6px; 
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px;
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICONS ---
        const Shield = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>;
        const FactoryIcon = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></svg>;
        const Crosshair = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg>;
        const AlertTriangle = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
        const CheckCircle = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const Lock = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
        const Users = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const ChevronRight = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"/></svg>;
        const DollarSign = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>;
        const Filter = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
        const Package = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m16.5 9.4-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>;
        const Trash2 = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const Plus = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const Calculator = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>;
        const KeyIcon = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21 2-2 2m-7.6 7.6a6.5 6.5 0 1 1-5.3 5.3L3 21l3-3 2.1-2.1a2 2 0 0 1 2.8 0L13.4 13.4a2 2 0 0 1 0 2.8l-4.3 4.3"/><path d="m10 10 1.5 1.5"/><path d="m14 6 1.5 1.5"/><path d="m18 2 1.5 1.5"/></svg>;
        const Zap = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
        const Heart = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 14c1.49-1.28 3.6-2.34 4.53-3.26a6.5 6.5 0 0 0-5.71-10.42 6.51 6.51 0 0 0-5.71 3.8A6.5 6.5 0 0 0 5.71 .32 6.51 6.51 0 0 0 0 5.22c.94.91 3.05 1.98 4.53 3.26L12 22l7-8z"/></svg>;
        const ArrowLeft = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>;
        const Briefcase = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>;
        const Database = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>;
        const Gift = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.9 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>;
        const Diamond = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 3h12l4 6-10 13L2 9Z"/><path d="M11 3 8 9l4 13 4-13-3-6"/><path d="M2 9h20"/></svg>;
        const Scale = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>;
        const Info = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;
        const LinkIcon = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07L13 7"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07L11 17"/></svg>;
        const BookIcon = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>;
        const MessageSquare = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;
        const Mail = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>;
        const Shuffle = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="9" x2="19" y2="13"/><line x1="4" y1="4" x2="8" y2="8"/></svg>;
        const TrendingUp = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>;
        const ZapOff = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="22" x2="12" y2="16"/><line x1="2" y1="12" x2="8" y2="12"/><path d="M13.88 9.94 17 6H10l-4 8h3l-2.61 3.51"/></svg>;
        const Globe = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10zM2.5 13H21.5"/></svg>;
        const ShoppingCart = ({size=20, className=""}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>;

        // --- DATASETS ---

        const INITIAL_MARKET_PRICES = {
            WAX: 1, 
            DOVX: 0.00528552,
            DOVR: 0.00045262,
            DOVH: 0.00045262,
            DOVF: 0.00045262,
            DOVS: 0.00045262,
        };

        const CHEST_DATA = {
            'Bunker': {
                zone: 4,
                name: 'PACK Bunker',
                tokenCost: 27, 
                drops: [
                    { type: 'building', pool: [
                        { id: 'c_f1_fuel', name: 'C_F1_PRODUCER_FUEL', prob: 24.98 },
                        { id: 'c_f1_repair', name: 'C_F1_PRODUCER_REPAIR', prob: 24.98 },
                        { id: 'c_f1_supply', name: 'C_F1_PRODUCER_SUPPLY', prob: 24.98 },
                        { id: 'c_f1_health', name: 'C_F1_PRODUCER_HEALTH', prob: 24.98 },
                        { id: 'c_f4_fuel', name: 'C_F4_PRODUCER_FUEL', prob: 0.02 },
                        { id: 'c_f4_supply', name: 'C_F4_PRODUCER_SUPPLY', prob: 0.02 },
                        { id: 'c_f4_repair', name: 'C_F4_PRODUCER_REPAIR', prob: 0.02 },
                        { id: 'c_f4_health', name: 'C_F4_PRODUCER_HEALTH', prob: 0.02 }
                    ]},
                    { type: 'key', pool: [
                        { id: 'F1-KEY-CITY', name: 'F1-KEY-CITY', prob: 33.33 },
                        { id: 'F1-KEY-BEACH', name: 'F1-KEY-BEACH', prob: 33.33 },
                        { id: 'F1-KEY-FOREST', name: 'F1-KEY-FOREST', prob: 33.33 }
                    ]}
                ]
            },
            'Camp': {
                zone: 8,
                name: 'PACK Camp',
                tokenCost: 27,
                drops: [
                    { type: 'building', pool: [
                        { id: 'r_f1_fuel', name: 'R_F1_PRODUCER_FUEL', prob: 24.98 },
                        { id: 'r_f1_repair', name: 'R_F1_PRODUCER_REPAIR', prob: 24.98 },
                        { id: 'r_f1_supply', name: 'R_F1_PRODUCER_SUPPLY', prob: 24.98 },
                        { id: 'r_f1_health', name: 'R_F1_PRODUCER_HEALTH', prob: 24.98 },
                        { id: 'r_f4_fuel', name: 'R_F4_PRODUCER_FUEL', prob: 0.02 },
                        { id: 'r_f4_supply', name: 'R_F4_PRODUCER_SUPPLY', prob: 0.02 },
                        { id: 'r_f4_repair', name: 'R_F4_PRODUCER_REPAIR', prob: 0.02 },
                        { id: 'r_f4_health', name: 'R_F4_PRODUCER_HEALTH', prob: 0.02 }
                    ]},
                    { type: 'key', pool: [
                        { id: 'F2-KEY-CITY', name: 'F2-KEY-CITY', prob: 33.33 },
                        { id: 'F1-KEY-HILL', name: 'F1-KEY-HILL', prob: 33.33 },
                        { id: 'F1-KEY-FOREST', name: 'F1-KEY-FOREST', prob: 33.33 }
                    ]}
                ]
            },
            'Radar': {
                zone: 12,
                name: 'PACK Radar',
                tokenCost: 27,
                drops: [
                    { type: 'building', pool: [
                        { id: 'e_f1_fuel', name: 'E_F1_PRODUCER_FUEL', prob: 24.98 },
                        { id: 'e_f1_repair', name: 'E_F1_PRODUCER_REPAIR', prob: 24.98 },
                        { id: 'e_f1_supply', name: 'E_F1_PRODUCER_SUPPLY', prob: 24.98 },
                        { id: 'e_f1_health', name: 'E_F1_PRODUCER_HEALTH', prob: 24.98 },
                        { id: 'e_f4_fuel', name: 'E_F4_PRODUCER_FUEL', prob: 0.02 },
                        { id: 'e_f4_supply', name: 'E_F4_PRODUCER_SUPPLY', prob: 0.02 },
                        { id: 'e_f4_repair', name: 'E_F4_PRODUCER_REPAIR', prob: 0.02 },
                        { id: 'e_f4_health', name: 'E_F4_PRODUCER_HEALTH', prob: 0.02 }
                    ]},
                    { type: 'key', pool: [
                        { id: 'F3-KEY-CITY', name: 'F3-KEY-CITY', prob: 33.33 },
                        { id: 'F1-KEY-HILL', name: 'F1-KEY-HILL', prob: 33.33 },
                        { id: 'F1-KEY-PLAINE', name: 'F1-KEY-PLAINE', prob: 33.33 }
                    ]}
                ]
            },
            'HQ': {
                zone: 16,
                name: 'PACK HQ',
                tokenCost: 27,
                drops: [
                    { type: 'building', pool: [
                        { id: 'l_f1_fuel', name: 'L_F1_PRODUCER_FUEL', prob: 24.98 },
                        { id: 'l_f1_repair', name: 'L_F1_PRODUCER_REPAIR', prob: 24.98 },
                        { id: 'l_f1_supply', name: 'L_F1_PRODUCER_SUPPLY', prob: 24.98 },
                        { id: 'l_f1_health', name: 'L_F1_PRODUCER_HEALTH', prob: 24.98 },
                        { id: 'r_f4_fuel', name: 'R_F4_PRODUCER_FUEL', prob: 0.02 }, 
                        { id: 'l_f4_supply', name: 'L_F4_PRODUCER_SUPPLY', prob: 0.02 },
                        { id: 'l_f4_repair', name: 'L_F4_PRODUCER_REPAIR', prob: 0.02 },
                        { id: 'r_f4_health', name: 'R_F4_PRODUCER_HEALTH', prob: 0.02 }
                    ]},
                    { type: 'key', pool: [
                        { id: 'F4-KEY-CITY', name: 'F4-KEY-CITY', prob: 33.33 },
                        { id: 'F1-KEY-PLAINE', name: 'F1-KEY-PLAINE', prob: 33.33 },
                        { id: 'F1-KEY-HILL', name: 'F1-KEY-HILL', prob: 33.33 }
                    ]}
                ]
            }
        };

        const generateFactories = () => {
            const types = ['FUEL', 'REPAIR', 'SUPPLY', 'HEALTH'];
            const rarities = [
                { name: 'Common', key: 'C', levels: [ { l: 1, out: 5.40, cost: 0.4590 }, { l: 2, out: 12.15, cost: 1.0328 }, { l: 3, out: 30.38, cost: 2.5819 }, { l: 4, out: 83.53, cost: 7.1002 }, { l: 5, out: 1458.00, cost: 123.9300, isBlend: true } ]},
                { name: 'Rare', key: 'R', levels: [ { l: 1, out: 16.20, cost: 1.3770 }, { l: 2, out: 36.45, cost: 3.0983 }, { l: 3, out: 91.13, cost: 7.7456 }, { l: 4, out: 250.59, cost: 21.3005 } ]},
                { name: 'Epic', key: 'E', levels: [ { l: 1, out: 48.60, cost: 4.1310 }, { l: 2, out: 109.35, cost: 9.2948 }, { l: 3, out: 273.38, cost: 23.2369 }, { l: 4, out: 751.78, cost: 63.9014 } ]},
                { name: 'Legendary', key: 'L', levels: [ { l: 1, out: 145.80, cost: 12.3930 }, { l: 2, out: 328.05, cost: 27.8843 }, { l: 3, out: 820.13, cost: 69.7106 }, { l: 4, out: 2255.34, cost: 191.7042 } ]},
                { name: 'Supreme', key: 'S', levels: [ { l: 1, out: 2255.34, cost: 191.7042 } ]}
            ];
            let list = [];
            let templateMap = {}; 

            types.forEach(type => {
                const typeKey = type.charAt(0);
                rarities.forEach(rarity => {
                    rarity.levels.forEach(level => {
                        if (level.l === 5 && rarity.name !== 'Common' && (type === 'SUPPLY' || type === 'HEALTH')) return; 

                        let name = `${rarity.name} ${type} ${level.l}`;
                        if (level.isBlend) {
                            name = `Supreme ${rarity.name} ${type} (Blend 10x F4)`;
                        }

                        const factory = {
                            id: `${rarity.key}_${typeKey}${level.l}`,
                            name: name,
                            type: type,
                            rarity: rarity.name,
                            level: level.l,
                            output: level.out,
                            costDoVX: level.cost,
                            efficiency: 100, 
                            accountsNeeded: 1,
                            equivalentF1s: 1,
                            dailyGrossWax: level.out * 24, 
                            dailyCostWax: level.cost * 24 
                        };

                        list.push(factory);
                        const levelKey = level.isBlend ? 5 : level.l;
                        templateMap[`${rarity.name.toUpperCase()}_${type.toUpperCase()}_L${levelKey}`] = factory;
                    });
                });
            });
            return { list, templateMap };
        };

        const { list: FACTORIES, templateMap: FACTORY_MAP } = generateFactories();

        const ZONES = [
            { id: 1, name: 'Beach 1', type: 'Beach', order: 1, win: 400, usage: 1160, minWeight: 14, keyReq: 0, officerReq: 1 },
            { id: 2, name: 'Beach 2', type: 'Beach', order: 2, win: 2405, usage: 6968, minWeight: 28, keyReq: 5, officerReq: 2 },
            { id: 3, name: 'Beach 3', type: 'Beach', order: 3, win: 3037, usage: 8800, minWeight: 55, keyReq: 6, officerReq: 3 },
            { id: 4, name: 'Bunker', type: 'Beach', order: 4, win: 3838, usage: 11120, minWeight: 109, keyReq: 7, officerReq: 4, isCheckpoint: true, unitReq: 'e2', bonusToken: "TOKEN-BUNKER" }, 
            { id: 5, name: 'Forest 1', type: 'Forest', order: 5, win: 4840, usage: 14024, minWeight: 219, keyReq: 8, officerReq: 5 },
            { id: 6, name: 'Forest 2', type: 'Forest', order: 6, win: 6110, usage: 17704, minWeight: 342, keyReq: 9, officerReq: 6 },
            { id: 7, name: 'Forest 3', type: 'Forest', order: 7, win: 7714, usage: 22352, minWeight: 450, keyReq: 10, officerReq: 7 },
            { id: 8, name: 'Camp', type: 'Forest', order: 8, win: 9739, usage: 28220, minWeight: 512, keyReq: 11, officerReq: 8, isCheckpoint: true, unitReq: 'e1', bonusToken: "TOKEN-CAMP" },
            { id: 9, name: 'Hill 1', type: 'Hill', order: 9, win: 12788, usage: 37052, minWeight: 695, keyReq: 12, officerReq: 9 },
            { id: 10, name: 'Hill 2', type: 'Hill', order: 10, win: 16791, usage: 48652, minWeight: 869, keyReq: 13, officerReq: 10 },
            { id: 11, name: 'Hill 3', type: 'Hill', order: 11, win: 22266, usage: 64516, minWeight: 1086, keyReq: 14, officerReq: 11 },
            { id: 12, name: 'Radar', type: 'Hill', order: 12, win: 29236, usage: 84712, minWeight: 1358, keyReq: 15, officerReq: 12, isCheckpoint: true, unitReq: 'e3', godmotherReq: true, bonusToken: "TOKEN-RADAR" },
            { id: 13, name: 'Plain 1', type: 'Plain', order: 13, win: 34300, usage: 99384, minWeight: 1697, keyReq: 16, officerReq: 13 },
            { id: 14, name: 'Plain 2', type: 'Plain', order: 14, win: 43385, usage: 125708, minWeight: 1866, keyReq: 17, officerReq: 14 },
            { id: 15, name: 'Plain 3', type: 'Plain', order: 15, win: 52171, usage: 151164, minWeight: 2052, keyReq: 18, officerReq: 15 },
            { id: 16, name: 'HQ', type: 'Plain', order: 16, win: 64884, usage: 188000, minWeight: 2495, keyReq: 19, officerReq: 16, isCheckpoint: true, unitReq: 'l1', godmotherReq: true, bonusToken: "TOKEN-HQ" },
            { id: 17, name: 'City 1', type: 'City', order: 17, win: 0, usage: 0, entryCostDovX: 777.35, minWeight: 108.53, keyReq: 9, officerReq: 1, bonusToken: "F1-TOKEN-CITY-2025", specificOfficer: 'o25', requiredUnits: ['e6', 'uc6', 'l2'] },
            { id: 18, name: 'City 2', type: 'City', order: 18, win: 0, usage: 0, entryCostDovX: 2213.87, minWeight: 511.76, keyReq: 13, officerReq: 1, bonusToken: "F2-TOKEN-CITY-2025", specificOfficer: 'o26', requiredUnits: ['uc5', 'c6', 'r4'] },
            { id: 19, name: 'City 3', type: 'City', order: 19, win: 0, usage: 0, entryCostDovX: 6677.85, minWeight: 1357.04, keyReq: 17, officerReq: 1, bonusToken: "F3-TOKEN-CITY-2025", specificOfficer: 'o27', requiredUnits: ['uc6', 'r5', 'e7', 'l2'] },
            { id: 20, name: 'Bridge', type: 'City', order: 20, win: 0, usage: 0, entryCostDovX: 14850.80, minWeight: 2494.23, keyReq: 20, officerReq: 1, bonusToken: "F4-TOKEN-CITY-2025", specificOfficer: 'o11', requiredUnits: ['e7', 'l2', 'l2'] } 
        ];

        // --- MOCK INVENTORY ---
        const ALL_OFFICERS = [
            { id: 'o1', name: 'F1-BRIGADIER-GEN-CLIFT-ANDRUS', order: 1 },
            { id: 'o2', name: 'F2-BRIGADIER-GEN-CLIFT-ANDRUS', order: 2 },
            { id: 'o3', name: 'F3-BRIGADIER-GEN-CLIFT-ANDRUS', order: 3 },
            { id: 'o4', name: 'F4-BRIGADIER-GEN-CLIFT-ANDRUS', order: 4 },
            { id: 'o5', name: 'F1-COLONEL-JOHN-F-R-SEITZ', order: 5 },
            { id: 'o6', name: 'F2-COLONEL-JOHN-F-R-SEITZ', order: 6 },
            { id: 'o7', name: 'F3-COLONEL-JOHN-F-R-SEITZ', order: 7 },
            { id: 'o8', name: 'F4-COLONEL-JOHN-F-R-SEITZ', order: 8 },
            { id: 'o9', name: 'F1-MAJOR-ERNEST-L-SMITH', order: 9 },
            { id: 'o10', name: 'F1-Major_Gen_C_R_HUEBNER', order: 13 },
            { id: 'o11', name: 'F1-L_COLONEL_G_A_TAYLOR', order: 17 },
            { id: 'o12', name: 'F1-MAJOR-GENERAL-WHAOU', order: 20 },
            { id: 'o13', name: 'F1-MAJOR-GENERAL-PANCAKE', order: 20 },
            { id: 'o14', name: 'F1-MAJOR-GENERAL-RAPHI', order: 1 },
            { id: 'o15', name: 'F1-MAJOR-GENERAL-ROLAND', order: 0 },
            { id: 'o16', name: 'F1-DOCTEUR-GENERAL-B.ANDREW', order: 0 },
            { id: 'o17', name: 'F1-MAJOR-GENERAL-DAGDAG', order: 0 },
            { id: 'o18', name: 'F1-BRIGADIER-GENERAL-KEVIN', order: 0 },
            { id: 'o19', name: 'F1-BRIGADIER-GENERAL-LUCAS', order: 0 },
            { id: 'o20', name: 'F1-LIEUTENANT-COMMANDER-ELODIE', order: 0 },
            { id: 'o21', name: 'F1-LIEUTENANT-GENERAL-GREG', order: 20 },
            { id: 'o22', name: 'F1-LIEUTENANT-GENERAL-OLIVER', order: 20 },
            { id: 'o23', name: 'F1-DIVISION-GENERAL-FLO', order: 1 },
            { id: 'o24', name: 'F1-BRIGADIER-GENERAL-NIMAJ', order: 1 },
            { id: 'o25', name: 'F1-CAP-JOY-BRIGHT-HANCOCK', order: 19 },
            { id: 'o26', name: 'F1-CAP-JEAN-PALMER', order: 20 },
            { id: 'o27', name: 'F1-COMMAND-RITA-LENIHAN', order: 21 },
        ];

        const ALL_SUPPORTS = [
            { id: 's1', name: 'F1-1st-MEDICAL-BATTALION', bonusPct: 0.5 },
            { id: 's2', name: 'F4-1st-MEDICAL-BATTALION', bonusPct: 3.0 },
            { id: 's3', name: 'F1-56th-SIGNAL-BATTALION', bonusPct: 1.5 },
            { id: 's4', name: 'F4-56th-SIGNAL-BATTALION', bonusPct: 4.5 },
            { id: 's5', name: 'F1-104th-MEDICAL-BATTALION', bonusPct: 2.5 },
            { id: 's6', name: 'F4-104th-MEDICAL-BATTALION', bonusPct: 10.0 },
            { id: 's7', name: 'F1-29-SIGNAL-COMPAGNY-XMAS', bonusPct: 2.5 },
            { id: 's8', name: 'F4-29-SIGNAL-COMPAGNY-XMAS', bonusPct: 10.0 },
            { id: 's9', name: 'F1-ASPIRANT-KIYO', bonusPct: 12.0 },
            { id: 's10', name: 'F2E-F4-104th-MEDICAL-BATTALION', bonusPct: 10.0 },
        ];

        const ALL_KEYS = [
            { id: 'k1', name: 'F1-KEY-BEACH', order: 4 },
            { id: 'k2', name: 'F2-KEY-BEACH', order: 5 },
            { id: 'k3', name: 'F3-KEY-BEACH', order: 6 },
            { id: 'k4', name: 'F4-KEY-BEACH', order: 7 },
            { id: 'k5', name: 'F1-KEY-FOREST', order: 8 },
            { id: 'k6', name: 'F2-KEY-FOREST', order: 9 },
            { id: 'k7', name: 'F3-KEY-FOREST', order: 10 },
            { id: 'k8', name: 'F4-KEY-FOREST', order: 11 },
            { id: 'k9', name: 'F1-KEY-HILL', order: 12 },
            { id: 'k10', name: 'F2-KEY-HILL', order: 13 },
            { id: 'k11', name: 'F3-KEY-HILL', order: 14 },
            { id: 'k12', name: 'F4-KEY-HILL', order: 15 },
            { id: 'k13', name: 'F1-KEY-PLAINE', order: 16 },
            { id: 'k14', name: 'F2-KEY-PLAINE', order: 17 },
            { id: 'k15', name: 'F3-KEY-PLAINE', order: 18 },
            { id: 'k16', name: 'F4-KEY-PLAINE', order: 19 },
            { id: 'k17', name: 'F1-KEY-CITY', order: 9 },
            { id: 'k18', name: 'F2-KEY-CITY', order: 13 },
            { id: 'k19', name: 'F3-KEY-CITY', order: 17 },
            { id: 'k20', name: 'F4-KEY-CITY', order: 20 },
        ];

        const ALL_GODMOTHERS = [
            { id: 'gm1', name: 'F1-Sonja-Henie-Xmas' },
            { id: 'gm2', name: 'F2-Sonja-Henie-Xmas' },
            { id: 'gm3', name: 'F3-Sonja-Henie-Xmas' },
            { id: 'gm4', name: 'F4-Sonja-Henie-Xmas' },
            { id: 'gm5', name: 'F4-GODMOTHER-SONJA-HENIE' },
            { id: 'gm6', name: 'F1-Miss-Betty-QTT' },
            { id: 'gm7', name: 'F1-DOROTHY-STRATTON' },
        ];

        const MOCK_INVENTORY = {
            keys: ALL_KEYS,
            officers: ALL_OFFICERS,
            supports: ALL_SUPPORTS,
            godmothers: ALL_GODMOTHERS,
            units: UNITS 
        };

        // --- NOUVEAU COMPOSANT : WAX MONITOR ---
        const WaxMonitor = () => {
            const [stats, setStats] = React.useState({ head: 0, lib: 0, producer: '---', diff: 0 });
            const [isLive, setIsLive] = React.useState(false);

            React.useEffect(() => {
                const fetchStats = async () => {
                    try {
                        const res = await fetch('https://wax.greymass.com/v1/chain/get_info');
                        if (!res.ok) throw new Error();
                        const data = await res.json();
                        setStats(prev => ({
                            head: data.head_block_num,
                            lib: data.last_irreversible_block_num,
                            producer: data.head_block_producer,
                            diff: data.head_block_num - prev.head 
                        }));
                        setIsLive(true);
                    } catch (e) {
                        setIsLive(false);
                    }
                };
                
                // Appel initial + Intervalle de 1 seconde (block time WAX = 0.5s, update UI = 1s)
                fetchStats();
                const interval = setInterval(fetchStats, 1000);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="bg-slate-800 border-l-4 border-orange-500 rounded-lg p-4 mb-6 shadow-lg relative overflow-hidden animate-fade-in">
                    {/* Background Tech Effect */}
                    <div className="absolute -right-4 -top-4 text-slate-700 opacity-20 rotate-12">
                        <Zap size={100} />
                    </div>

                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 relative z-10">
                        {/* Status Section */}
                        <div className="flex items-center gap-4">
                            <div className="relative">
                                <div className={`w-3 h-3 rounded-full ${isLive ? 'bg-emerald-500 shadow-[0_0_10px_#10b981]' : 'bg-red-500'}`}></div>
                                {isLive && <div className="absolute top-0 left-0 w-3 h-3 bg-emerald-500 rounded-full animate-ping opacity-75"></div>}
                            </div>
                            <div>
                                <h3 className="text-orange-400 font-bold font-mono tracking-widest text-sm">WAX NETLINK</h3>
                                <div className="text-[10px] text-slate-400">RPC: GREYMASS PUBLIC NODE</div>
                            </div>
                        </div>

                        {/* Data Grid */}
                        <div className="flex gap-6 md:gap-12 text-center">
                            <div>
                                <div className="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Head Block</div>
                                <div className="text-xl font-mono font-bold text-white tabular-nums">
                                    {stats.head.toLocaleString()}
                                </div>
                            </div>
                            
                            <div className="hidden sm:block">
                                <div className="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Irreversible</div>
                                <div className="text-xl font-mono font-bold text-blue-400 tabular-nums">
                                    {stats.lib.toLocaleString()}
                                </div>
                            </div>

                            <div>
                                <div className="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Producer</div>
                                <div className="text-xl font-mono font-bold text-yellow-400 truncate max-w-[150px]">
                                    {stats.producer}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // --- NOUVEAU COMPOSANT : AFFICHAGE PRIX D'ACHAT ALCOR (DOVX) ---
        const DovxMarketPrice = () => {
            const [price, setPrice] = useState('Chargement...');
            const [error, setError] = useState(false);
            
            const ALCOR_ORDERBOOK_API = 'https://alcor.exchange/api/v2/market/orderbook/dovx-dovvaultfort_wax-eosio.token';

            useEffect(() => {
                const fetchBestAsk = async () => {
                    try {
                        const response = await fetch(ALCOR_ORDERBOOK_API);
                        if (!response.ok) throw new Error('Erreur Alcor');
                        
                        const data = await response.json();
                        
                        if (data.asks && data.asks.length > 0) {
                            const lowestAskPrice = parseFloat(data.asks[0].price);
                            setPrice(lowestAskPrice.toFixed(6));
                            setError(false);
                        } else {
                            setPrice('N/A');
                            setError(false);
                        }
                    } catch (e) {
                        console.error("Erreur Alcor Orderbook:", e);
                        setPrice('API HORS LIGNE');
                        setError(true);
                    }
                };

                fetchBestAsk();
                const intervalId = setInterval(fetchBestAsk, 15000); 

                return () => clearInterval(intervalId);
            }, []);

            return (
                <div className="flex flex-col ml-6 pl-4 border-l border-slate-700/50">
                    <span className="text-xs text-blue-400 font-bold mb-1">Meilleur Achat DOV-X (Alcor)</span>
                    <div className={`text-lg font-mono font-bold ${error ? 'text-red-400' : 'text-blue-300'}`}>
                        {price} WAX
                    </div>
                </div>
            );
        };
        
        // --- NOUVEAU COMPOSANT : OFFICIAL LINKS ---
        const DovLinksSection = () => {
            const links = [
                { name: "Site Officiel", url: "https://dawnofvictory.io/", icon: <LinkIcon size={16} className="text-blue-400"/>, color: "blue" },
                { name: "Whitepaper (Gitbook)", url: "https://dawn-of-victory.gitbook.io/dov/", icon: <BookIcon size={16} className="text-purple-400"/>, color: "purple" },
                { name: "Accès Bêta", url: "https://beta.dawnofvictory.io/", icon: <CheckCircle size={16} className="text-emerald-400"/>, color: "emerald" },
                { name: "Twitter", url: "https://twitter.com/DOVNFT", icon: <MessageSquare size={16} className="text-cyan-400"/>, color: "cyan" },
                { name: "Telegram", url: "https://t.me/dawnofvictorynft", icon: <MessageSquare size={16} className="text-indigo-400"/>, color: "indigo" },
                { name: "Échange DOV-X (Alcor)", url: "https://alcor.exchange/trade/dovx-dovvaultfort_wax-eosio.token", icon: <TrendingUp size={16} className="text-green-400"/>, color: "green" },
                { name: "Swap WAX/DOV-X (Alcor)", url: "https://wax.alcor.exchange/swap?output=DOVX-dovvaultfort&input=WAX-eosio.token", icon: <Shuffle size={16} className="text-yellow-400"/>, color: "yellow" },
                { name: "Blend NFT (NeftyBlocks)", url: "https://neftyblocks.com/c/dovdivisions/blends", icon: <Package size={16} className="text-orange-400"/>, color: "orange" },
                { name: "Top 100 DOVX Holders (Bloks)", url: "https://wax.bloks.io/tokens/DOVX-wax-dovvaultfort", icon: <Database size={16} className="text-slate-400"/>, color: "slate" },
                { name: "Fichier de Ressources Partagé", url: "https://whimsical.com/dawn-of-victory-marketing-NgpNonWnGyLUqosCRRJ5Ng@3CRerdhrAvzbxBHgLbRvGZoU", icon: <Info size={16} className="text-pink-400"/>, color: "pink" },
            ];

            return (
                <Card className="mb-6 border-l-4 border-blue-500">
                    <h3 className="text-xl font-bold text-blue-400 mb-4 flex items-center gap-2">
                        <Shield size={24} /> Ressources Officielles Dawn of Victory (DOV)
                    </h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        {links.map((link, index) => (
                            <a 
                                key={index} 
                                href={link.url} 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className={`flex items-center p-3 rounded-lg border border-slate-700 bg-slate-900 hover:bg-slate-700/50 transition-colors text-sm font-medium text-white`}
                            >
                                {link.icon}
                                <span className="ml-3 truncate">{link.name}</span>
                                <ChevronRight size={16} className="ml-auto text-slate-500" />
                            </a>
                        ))}
                    </div>
                </Card>
            );
        };
        
        // --- NOUVEAU COMPOSANT : MACRO ECONOMIC DASHBOARD (Ancien GlobalStats) ---
        const MacroEconomicDashboard = ({ FACTORY_MAP, marketPrices }) => {
            const [macroStats, setMacroStats] = useState({
                tvlWax: 0,
                tvlUsd: 0,
                eer: 0,
                isTvlLoading: true,
                error: null,
                totalBuildings: 0,
                finalStats: [],
            });

            // Mapping des couleurs et des labels
            const rarityColors = { 'Common': 'blue', 'Rare': 'emerald', 'Epic': 'purple', 'Legendary': 'yellow', 'Supreme': 'red' };
            const rarityLabels = { 'Common': 'Commun', 'Rare': 'Rare', 'Epic': 'Épique', 'Legendary': 'Légendaire', 'Supreme': 'Suprême' };

            useEffect(() => {
                const fetchGlobalStats = async () => {
                    setMacroStats(prev => ({ ...prev, isTvlLoading: true, error: null }));
                    
                    try {
                        // URL de l'API AtomicAssets pointant sur le schéma 'warbuildings'
                        const API_ENDPOINT = 'https://wax.api.atomicassets.io/atomicassets/v1/templates?collection_name=dovdivisions&schema_name=warbuildings&limit=100&page=1&order=desc&sort=created';
                        
                        const response = await fetch(API_ENDPOINT);
                        if (!response.ok) {
                            throw new Error(`Erreur API: ${response.status} (${response.statusText})`);
                        }
                        const data = await response.json();
                        
                        let totalTVLWax = 0;
                        let totalGrossAnnualWax = 0;
                        let totalCostAnnualWax = 0;
                        let totalBuildings = 0;
                        const aggregated = {};
                        const roiTargetDays = 365;

                        if (data.data && data.data.length > 0) {
                            data.data.forEach(template => {
                                const rarity = template.immutable_data.rarity || 'Common';
                                const prodType = template.immutable_data.type || 'FUEL';
                                const level = template.immutable_data.level || 1; 

                                // Recherche du modèle dans la carte statique
                                const levelKey = (rarity === 'Common' && level === 5) ? 5 : level;
                                const factoryKey = `${rarity.toUpperCase()}_${prodType.toUpperCase()}_L${levelKey}`;
                                const factoryInfo = FACTORY_MAP[factoryKey];
                                
                                const supply = parseInt(template.circulating_supply);
                                
                                if (supply > 0 && factoryInfo) {
                                    totalBuildings += supply;
                                    
                                    // Calculs basés sur le marché simulé (marketPrices)
                                    const resourcePriceKey = `DOV${factoryInfo.type.charAt(0)}`;
                                    const dailyProdWax = factoryInfo.output * 24 * marketPrices[resourcePriceKey]; 
                                    const dailyCostWax = factoryInfo.costDoVX * 24 * marketPrices.DOVX;
                                    const dailyNetWax = dailyProdWax - dailyCostWax;

                                    // 1. Calcul TVL (Fair Value = Rdt Net Annuel)
                                    const fairValueWax = dailyNetWax * roiTargetDays;
                                    totalTVLWax += fairValueWax * supply;
                                    
                                    // 2. Agrégation pour EER
                                    totalGrossAnnualWax += (dailyProdWax * 365) * supply;
                                    totalCostAnnualWax += (dailyCostWax * 365) * supply;
                                    
                                    // 3. Agrégation pour le tableau des quantités
                                    const aggKey = `${rarity}_${prodType}`;
                                    if (!aggregated[aggKey]) {
                                        aggregated[aggKey] = { rarity: rarity, prodType: prodType, count: 0 };
                                    }
                                    aggregated[aggKey].count += supply;
                                }
                            });
                        }
                        
                        const eer = totalCostAnnualWax > 0 ? (totalGrossAnnualWax / totalCostAnnualWax) : 0;
                        const tvlUsd = totalTVLWax * marketPrices.WAX;

                        const finalStats = Object.values(aggregated).map(item => ({
                            ...item,
                            name: `${rarityLabels[item.rarity] || item.rarity} ${item.prodType}`,
                            color: rarityColors[item.rarity] || 'slate'
                        }));
                        
                        finalStats.sort((a, b) => b.count - a.count);

                        setMacroStats({
                            tvlWax: totalTVLWax,
                            tvlUsd: tvlUsd,
                            eer: eer,
                            isTvlLoading: false,
                            error: null,
                            totalBuildings: totalBuildings,
                            finalStats: [{ name: "Total Bâtiments Uniques", count: totalBuildings, color: 'orange', isTotal: true }, ...finalStats]
                        });
                        
                    } catch (err) {
                        console.error("Erreur de récupération des stats NFT:", err);
                        setMacroStats(prev => ({
                            ...prev,
                            isTvlLoading: false,
                            error: "Échec de l'API AtomicAssets. Veuillez réessayer dans quelques minutes."
                        }));
                    }
                };

                fetchGlobalStats(); 
                const intervalId = setInterval(fetchGlobalStats, 120000); 

                return () => clearInterval(intervalId);
            }, [marketPrices.DOVX, marketPrices.DOVF, marketPrices.WAX]); 

            if (macroStats.isTvlLoading) {
                return <Card className="text-center py-6"><div className="text-orange-400 font-bold">Analyse Macro en cours...</div><p className="text-xs text-slate-500 mt-2">Récupération des données NFT (TVL/EER)</p></Card>;
            }

            if (macroStats.error) {
                return (
                    <Card className="text-center py-6 bg-red-900/30 border-red-700/50">
                        <div className="text-red-400 font-bold flex items-center justify-center gap-2">
                            <AlertTriangle size={20} /> {macroStats.error}
                        </div>
                        <p className="text-xs text-red-300 mt-2">
                            La simulation fonctionne toujours sur les données statiques, mais les indicateurs macro sont temporairement indisponibles.
                        </p>
                    </Card>
                );
            }

            return (
                <div className="space-y-6">
                    <Card className="border-t-4 border-emerald-500">
                        <h3 className="text-xl font-bold text-emerald-400 mb-6 flex items-center gap-2">
                            <Globe size={24} /> Macro-Dashboard Économique DOV
                        </h3>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            
                            {/* Indicateur 1: Total Value Locked (TVL) */}
                            <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700 text-center">
                                <div className="text-xs text-emerald-400 uppercase font-bold">Total Value Locked (TVL)</div>
                                <div className="text-3xl font-mono font-bold text-white mt-1">
                                    {macroStats.tvlWax.toLocaleString(undefined, {maximumFractionDigits: 0})} WAX
                                </div>
                                <div className="text-sm text-slate-400">
                                    ≈ ${macroStats.tvlUsd.toLocaleString(undefined, {maximumFractionDigits: 2})} USD
                                </div>
                                <p className="text-[10px] text-slate-500 mt-2">Valeur basée sur le rendement net annuel (Fair Value).</p>
                            </div>
                            
                            {/* Indicateur 2: Engine Efficiency Ratio (EER) */}
                            <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700 text-center">
                                <div className="text-xs text-orange-400 uppercase font-bold">Rendement du Moteur (EER)</div>
                                <div className={`text-3xl font-mono font-bold mt-1 ${macroStats.eer >= 1 ? 'text-yellow-400' : 'text-red-400'}`}>
                                    {macroStats.eer.toFixed(2)} x
                                </div>
                                <div className="text-sm text-slate-400">
                                    (Prod Annuelle Brute / Coût Annuel)
                                </div>
                                <p className="text-[10px] text-slate-500 mt-2">Un EER > 1.0x démontre un moteur efficace avec rendement net.</p>
                            </div>
                            
                            {/* Indicateur 3: Total Assets in Circulation */}
                            <div className="p-4 bg-slate-900/50 rounded-lg border border-slate-700 text-center">
                                <div className="text-xs text-blue-400 uppercase font-bold">Total Bâtiments NFT</div>
                                <div className="text-3xl font-mono font-bold text-white mt-1">
                                    {macroStats.totalBuildings.toLocaleString()}
                                </div>
                                <div className="text-sm text-slate-400">
                                    Unités en Circulation
                                </div>
                                <p className="text-[10px] text-slate-500 mt-2">Masse critique de l'écosystème d'actifs du jeu.</p>
                            </div>

                        </div>
                    </Card>
                    
                    {/* Tableau de la répartition des actifs */}
                    <Card>
                        <h4 className="text-lg font-bold text-slate-300 mb-4 flex items-center gap-2">
                             <Database size={20} /> Répartition de la Base d'Actifs NFT
                        </h4>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse">
                                <thead>
                                    <tr className="text-slate-400 border-b border-slate-700 text-xs uppercase bg-slate-800/50">
                                        <th className="p-3">Type de Bâtiment</th>
                                        <th className="p-3 text-right">Quantité Totale</th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm">
                                    {macroStats.finalStats.filter(s => !s.isTotal).map((stat, index) => (
                                        <tr key={index} className="border-b border-slate-700 hover:bg-slate-800/50 transition-colors">
                                            <td className="p-3 font-bold text-white">
                                                <Badge color={stat.color}>{stat.rarity}</Badge> {stat.prodType}
                                            </td>
                                            <td className="p-3 text-right font-mono text-white">
                                                {stat.count.toLocaleString()}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot>
                                    <tr className="font-bold bg-slate-700/50">
                                        <td className="p-3 text-white">TOTAL GÉNÉRAL</td>
                                        <td className="p-3 text-right font-mono text-orange-400">
                                            {macroStats.totalBuildings.toLocaleString()}
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </Card>
                </div>
            );
        }

        // --- COMPONENTS STANDARDS ---

        const Card = ({ children, className = "" }) => <div className={`bg-slate-800 border border-slate-700 rounded-lg p-4 shadow-xl ${className}`}>{children}</div>;
        const Badge = ({ children, color = "blue" }) => {
            const colors = {
                blue: "bg-blue-900 text-blue-200 border-blue-700",
                green: "bg-emerald-900 text-emerald-200 border-emerald-700",
                red: "bg-red-900 text-red-200 border-red-700",
                yellow: "bg-yellow-900 text-yellow-200 border-yellow-700",
                purple: "bg-purple-900 text-purple-200 border-purple-700",
                pink: "bg-pink-900 text-pink-200 border-pink-700",
                slate: "bg-slate-700 text-slate-300 border-slate-600",
                indigo: "bg-indigo-900 text-indigo-200 border-indigo-700",
                cyan: "bg-cyan-900 text-cyan-200 border-cyan-700",
                orange: "bg-orange-900 text-orange-200 border-orange-700", 
                emerald: "bg-emerald-900 text-emerald-200 border-emerald-700", 
            };
            return <span className={`px-2 py-1 rounded text-xs font-bold border ${colors[color] || colors.blue}`}>{children}</span>;
        };

        // --- APP MAIN ---

        function DoVManager() {
            const [activeTab, setActiveTab] = useState('global_stats'); // Défini sur le nouvel onglet
            const [viewMode, setViewMode] = useState('dashboard');
            const [marketPrices, setMarketPrices] = useState(INITIAL_MARKET_PRICES);
            const [waxPriceUsd, setWaxPriceUsd] = useState(0.008); 
            const [userInventory, setUserInventory] = useState(MOCK_INVENTORY);
            const [factoryFilter, setFactoryFilter] = useState('ALL');
            const [unitRarityFilter, setUnitRarityFilter] = useState('ALL');
            const [valuationFilter, setValuationFilter] = useState('ALL');
            const [timeframe, setTimeframe] = useState('day');
            const [tuRatio, setTuRatio] = useState(INITIAL_MARKET_PRICES.DOVF / INITIAL_MARKET_PRICES.DOVX);

            const [packBuilder, setPackBuilder] = useState({ name: 'Pack Personnalisé', price: 100, contents: [] });
            const [packPriceUsdStr, setPackPriceUsdStr] = useState("0.80"); 
            const [dovxInputStr, setDovxInputStr] = useState(INITIAL_MARKET_PRICES.DOVX.toString());
            const [tuInputStr, setTuInputStr] = useState(INITIAL_MARKET_PRICES.DOVF.toString());
            const [selectedFactoryToAdd, setSelectedFactoryToAdd] = useState(FACTORIES[0].id);
            const [targetRoi, setTargetRoi] = useState('');

            // ACCOUNT SIMULATOR STATES
            const [accountBuildings, setAccountBuildings] = useState([FACTORIES[0].id, FACTORIES[1].id, FACTORIES[2].id, FACTORIES[3].id]); 
            const [accountDivisions, setAccountDivisions] = useState([1, 1, 1]); 

            // CHEST SIMULATOR STATES
            const [selectedChestType, setSelectedChestType] = useState('Bunker');
            const [numChestsToOpen, setNumChestsToOpen] = useState(1);
            const [chestSimulationResults, setChestSimulationResults] = useState(null);

            // ROI ADVANCED STATES
            const [chestEstimates, setChestEstimates] = useState({
                'Bunker': 50,
                'Camp': 100,
                'Radar': 250,
                'HQ': 1000,
                'Bridge': 2000 
            });
            
            // ROI TARGET
            const [roiTargetDays, setRoiTargetDays] = useState(365);
            const [cpuPerAccount, setCpuPerAccount] = useState(250); // Valeur par défaut 250 WAX
            
            // COMBAT STATES
            const [selectedZoneId, setSelectedZoneId] = useState(1);
            const [selectedSquad, setSelectedSquad] = useState([]); 
            const [selectedSupport, setSelectedSupport] = useState(null);
            const [selectedOfficer, setSelectedOfficer] = useState(null);
            const [selectedKey, setSelectedKey] = useState(null);
            const [selectedGodmother, setSelectedGodmother] = useState(null);
            const [activeDivision, setActiveDivision] = useState(1);

            // OPTIONS GENERATOR
            const [autoGenOptions, setAutoGenOptions] = useState({
                budget: "50",
                roi: "30",
                limit4: false,
                diverse: false
            });

            // --- LOGIQUE: Récupération du prix WAX en temps réel ---
            useEffect(() => {
                const fetchWaxPrice = async () => {
                    try {
                        const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=wax&vs_currencies=usd');
                        if (!response.ok) throw new Error('API request failed');
                        const data = await response.json();
                        const newPrice = data.wax.usd;
                        
                        if (newPrice && newPrice !== waxPriceUsd) {
                            setWaxPriceUsd(newPrice);
                        }
                    } catch (error) {
                        console.error("Erreur lors de la récupération du prix WAX:", error);
                    }
                };

                fetchWaxPrice(); 
                const intervalId = setInterval(fetchWaxPrice, 60000); // Rafraîchir toutes les 60 secondes

                return () => clearInterval(intervalId); 
            }, [waxPriceUsd]); 

            const handleGlobalWaxPriceChange = (val) => {
                const newWaxPrice = parseFloat(val);
                setWaxPriceUsd(newWaxPrice);
                const usdPrice = parseFloat(packPriceUsdStr);
                if (!isNaN(usdPrice) && newWaxPrice > 0) {
                    setPackBuilder(prev => ({ ...prev, price: usdPrice / newWaxPrice }));
                }
            };
            const handleSimulationSlider = (e) => {
                const newDovx = parseFloat(e.target.value);
                setDovxInputStr(newDovx.toString());
                const newTu = newDovx * tuRatio;
                setTuInputStr(newTu.toString());
                setMarketPrices({ ...marketPrices, DOVX: newDovx, DOVF: newTu, DOVR: newTu, DOVS: newTu, DOVH: newTu });
            };
            const handleManualDovxChange = (val) => {
                setDovxInputStr(val); 
                const newDovx = parseFloat(val);
                if (!isNaN(newDovx)) {
                    setMarketPrices({ ...marketPrices, DOVX: newDovx, DOVF: newDovx * tuRatio, DOVR: newDovx * tuRatio, DOVS: newDovx * tuRatio, DOVH: newDovx * tuRatio });
                    setTuInputStr((newDovx * tuRatio).toString());
                }
            };
            const handleManualTuChange = (val) => {
                setTuInputStr(val);
                const newTu = parseFloat(val);
                if (!isNaN(newTu)) {
                    setMarketPrices({ ...marketPrices, DOVF: newTu, DOVR: newTu, DOVS: newTu, DOVH: newTu });
                    if(marketPrices.DOVX > 0) setTuRatio(newTu / marketPrices.DOVX);
                }
            };

            const handleSimulateChests = () => {
                const chest = CHEST_DATA[selectedChestType];
                if (!chest) return;
                let results = { buildingDrops: {}, keyDrops: {}, totalValueWax: 0 };
                const pickItem = (pool) => {
                   const totalWeight = pool.reduce((acc, item) => acc + item.prob, 0);
                   let random = Math.random() * totalWeight;
                   for (let item of pool) {
                       if (random < item.prob) return item;
                       random -= item.prob;
                   }
                   return pool[pool.length - 1];
                };
                for(let i=0; i<numChestsToOpen; i++) {
                    const building = pickItem(chest.drops[0].pool);
                    results.buildingDrops[building.name] = (results.buildingDrops[building.name] || 0) + 1;
                    const key = pickItem(chest.drops[1].pool);
                    results.keyDrops[key.name] = (results.keyDrops[key.name] || 0) + 1;
                }
                setChestSimulationResults(results);
            };

            const addToPack = () => {
                const existing = packBuilder.contents.find(i => i.factoryId === selectedFactoryToAdd);
                if (existing) {
                    setPackBuilder({ ...packBuilder, contents: packBuilder.contents.map(i => i.factoryId === selectedFactoryToAdd ? {...i, qty: i.qty + 1} : i) });
                } else {
                    setPackBuilder({ ...packBuilder, contents: [...packBuilder.contents, { factoryId: selectedFactoryToAdd, qty: 1 }] });
                }
            };
            const removeFromPack = (id) => setPackBuilder({ ...packBuilder, contents: packBuilder.contents.filter(i => i.factoryId !== id) });
            const updatePackQty = (id, newQty) => { if (newQty >= 1) setPackBuilder({ ...packBuilder, contents: packBuilder.contents.map(i => i.factoryId === id ? {...i, qty: parseInt(newQty)} : i) }); };
            
            const updatePriceFromRoi = (daysStr) => {
                setTargetRoi(daysStr);
                const days = parseFloat(daysStr);
                if (!days || days <= 0) return;
                let dailyNetWax = 0;
                packBuilder.contents.forEach(item => {
                    const factory = FACTORIES.find(f => f.id === item.factoryId);
                    if (factory) {
                        const prod = factory.output * 24 * marketPrices[`DOV${factory.type.charAt(0)}`] * item.qty;
                        const cost = factory.costDoVX * 24 * marketPrices.DOVX * item.qty;
                        dailyNetWax += (prod - cost);
                    }
                });
                if (dailyNetWax > 0) {
                    const newPrice = dailyNetWax * days;
                    setPackBuilder(prev => ({...prev, price: parseFloat(newPrice.toFixed(2))}));
                    setPackPriceUsdStr((newPrice * waxPriceUsd).toFixed(2));
                }
            };
            const handleWaxPriceChange = (val) => {
                setTargetRoi('');
                const waxVal = parseFloat(val);
                if (!isNaN(waxVal)) {
                    setPackBuilder(prev => ({...prev, price: waxVal}));
                    setPackPriceUsdStr((waxVal * waxPriceUsd).toFixed(2));
                }
            };
            const handleUsdPriceChange = (val) => {
                setTargetRoi('');
                setPackPriceUsdStr(val); 
                const usdVal = parseFloat(val);
                if (!isNaN(usdVal) && waxPriceUsd > 0) {
                    const waxVal = usdVal / waxPriceUsd;
                    setPackBuilder(prev => ({...prev, price: waxVal}));
                }
            };
            
            const generateAutoPack = () => {
                const targetPriceUsd = parseFloat(autoGenOptions.budget);
                const targetRoi = parseFloat(autoGenOptions.roi);
                const limitBuildings = autoGenOptions.limit4;
                const diversify = autoGenOptions.diverse;

                if (!targetPriceUsd || !targetRoi || targetRoi <= 0) return;

                const requiredDailyProfitUsd = targetPriceUsd / targetRoi;

                let candidates = FACTORIES.map(f => {
                    const resPrice = marketPrices[`DOV${f.type.charAt(0)}`];
                    const dailyProdWax = f.output * 24 * resPrice;
                    const dailyCostWax = f.costDoVX * 24 * marketPrices.DOVX;
                    const dailyNetWax = dailyProdWax - dailyCostWax;
                    const dailyNetUsd = dailyNetWax * waxPriceUsd;
                    return { ...f, dailyNetUsd };
                }).filter(f => f.dailyNetUsd > 0);

                candidates.sort((a, b) => b.dailyNetUsd - a.dailyNetUsd);

                let selectedContents = [];
                let currentProfit = 0;
                let slotsUsed = 0;

                if (diversify) {
                    const types = ['FUEL', 'REPAIR', 'SUPPLY', 'HEALTH'];
                    for (let type of types) {
                         if (limitBuildings && slotsUsed >= 4) break;
                         const bestOfType = candidates.find(c => c.type === type);
                         if (bestOfType && (currentProfit + bestOfType.dailyNetUsd <= requiredDailyProfitUsd * 1.5)) {
                             selectedContents.push({ factoryId: bestOfType.id, qty: 1 });
                             currentProfit += bestOfType.dailyNetUsd;
                             slotsUsed++;
                         }
                    }
                }
                
                for (let factory of candidates) {
                    if (currentProfit >= requiredDailyProfitUsd) break;
                    if (limitBuildings && slotsUsed >= 4) break;

                    const needed = requiredDailyProfitUsd - currentProfit;
                    let count = Math.ceil(needed / factory.dailyNetUsd);

                    if (limitBuildings) {
                        const slotsLeft = 4 - slotsUsed;
                        count = Math.min(count, slotsLeft);
                    }
                    
                    if (count > 0) {
                        const existingIdx = selectedContents.findIndex(i => i.factoryId === factory.id);
                        if (existingIdx >= 0) {
                            selectedContents[existingIdx].qty += count;
                        } else {
                            selectedContents.push({ factoryId: factory.id, qty: count });
                        }
                        currentProfit += factory.dailyNetUsd * count;
                        slotsUsed += count;
                    }
                }

                setPackBuilder({
                    name: `Pack Auto ${targetRoi}j ROI ($${targetPriceUsd})`,
                    price: targetPriceUsd / waxPriceUsd,
                    contents: selectedContents
                });
                setPackPriceUsdStr(targetPriceUsd.toString());
                setTargetRoi(targetRoi.toString());
            };


            useEffect(() => {
                if (targetRoi && parseFloat(targetRoi) > 0) {
                    const days = parseFloat(targetRoi);
                    let dailyNetWax = 0;
                    packBuilder.contents.forEach(item => {
                        const factory = FACTORIES.find(f => f.id === item.factoryId);
                        if(factory) {
                            const prod = factory.output * 24 * marketPrices[`DOV${factory.type.charAt(0)}`] * item.qty;
                            const cost = factory.costDoVX * 24 * marketPrices.DOVX * item.qty;
                            dailyNetWax += (prod - cost);
                        }
                    });
                    if (dailyNetWax > 0) {
                        const newPrice = dailyNetWax * days;
                        if(Math.abs(packBuilder.price - newPrice) > 0.01) {
                            setPackBuilder(prev => ({...prev, price: parseFloat(newPrice.toFixed(2))}));
                            setPackPriceUsdStr((newPrice * waxPriceUsd).toFixed(2));
                        }
                    }
                }
            }, [marketPrices, packBuilder.contents, targetRoi]);

            const packStats = useMemo(() => {
                let totalDailyProdWax = 0, totalDailyCostWax = 0;
                packBuilder.contents.forEach(item => {
                    const factory = FACTORIES.find(f => f.id === item.factoryId);
                    if (factory) {
                        totalDailyProdWax += factory.output * 24 * marketPrices[`DOV${factory.type.charAt(0)}`] * item.qty;
                        totalDailyCostWax += factory.costDoVX * 24 * marketPrices.DOVX * item.qty;
                    }
                });
                const dailyNetWax = totalDailyProdWax - totalDailyCostWax;
                const roiDays = dailyNetWax > 0 ? (packBuilder.price / dailyNetWax) : 0;
                
                // Detailed projections
                const monthlyNetWax = dailyNetWax * 30;
                const yearlyNetWax = dailyNetWax * 365;
                const totalRoiPeriodWax = dailyNetWax * roiDays;
                
                // NEW: APR Calculation (Annual Percentage Rate)
                // APR = (Yearly Profit / Investment) * 100
                const apr = packBuilder.price > 0 ? (yearlyNetWax / packBuilder.price) * 100 : 0;

                return { totalDailyProdWax, totalDailyCostWax, dailyNetWax, roiDays, monthlyNetWax, yearlyNetWax, totalRoiPeriodWax, apr };
            }, [packBuilder, marketPrices]);

            const productionAnalysis = useMemo(() => {
                return FACTORIES.map(factory => {
                    const dailyProdWax = factory.output * 24 * marketPrices[`DOV${factory.type.charAt(0)}`]; 
                    const dailyCostWax = factory.costDoVX * 24 * marketPrices.DOVX;
                    const dailyProfitWax = dailyProdWax - dailyCostWax;
                    const dailyProfitUsd = dailyProfitWax * waxPriceUsd;
                    const monthlyProdWax = dailyProdWax * 30;
                    const monthlyCostWax = dailyCostWax * 30;
                    const monthlyProfitWax = dailyProfitWax * 30;
                    const monthlyProfitUsd = dailyProfitUsd * 30;
                    const unitCost = (factory.costDoVX * marketPrices.DOVX) / factory.output;
                    const marketPrice = marketPrices[`DOV${factory.type.charAt(0)}`];
                    
                    const fairValueWax = dailyProfitWax * roiTargetDays;
                    const fairValueUsd = fairValueWax * waxPriceUsd;

                    const baseFactory = FACTORIES.find(f => f.type === factory.type && f.rarity === 'Common' && f.level === 1);
                    const baseOutput = baseFactory ? (baseFactory.output * 24) : (factory.output * 24);
                    
                    const equivalentF1s = baseOutput > 0 ? (factory.output * 24) / baseOutput : 1;
                    const accountsNeeded = equivalentF1s / 4; 
                    
                    let costInF1s = 1;
                    if (factory.level === 2) costInF1s = 3;
                    if (factory.level === 3) costInF1s = 9;
                    if (factory.level === 4) costInF1s = 27;
                    if (factory.level === 5) costInF1s = 270; 
                    
                    const f1DailyProd = baseFactory ? baseFactory.output * 24 : 5.4 * 24;
                    const theoreticalMax = costInF1s * f1DailyProd;
                    
                    const actualOutput = factory.output * 24;
                    const efficiency = theoreticalMax > 0 ? (actualOutput / theoreticalMax) * 100 : 0;

                    return { 
                        ...factory, 
                        displayProdWax: timeframe === 'day' ? dailyProdWax : monthlyProdWax, 
                        displayCostWax: timeframe === 'day' ? dailyCostWax : monthlyCostWax, 
                        displayProfitWax: timeframe === 'day' ? dailyProfitWax : monthlyProfitWax, 
                        displayProfitUsd: timeframe === 'day' ? dailyProfitUsd : monthlyProfitUsd, 
                        displayOutput: timeframe === 'day' ? (factory.output * 24) : (factory.output * 24 * 30), 
                        displayCostDoVX: timeframe === 'day' ? (factory.costDoVX * 24) : (factory.costDoVX * 24 * 30), 
                        unitCost, 
                        marketPrice, 
                        isProfitable: dailyProfitWax > 0, 
                        betterToBuy: unitCost > marketPrice,
                        fairValueWax, 
                        fairValueUsd,
                        equivalentF1s, 
                        accountsNeeded, 
                        efficiency 
                    };
                });
            }, [marketPrices, waxPriceUsd, timeframe, roiTargetDays]);

            const filteredFactories = useMemo(() => {
                if (factoryFilter === 'ALL') return productionAnalysis;
                return productionAnalysis.filter(f => f.type === factoryFilter);
            }, [productionAnalysis, factoryFilter]);

            const getKeyNameFromOrder = (order) => {
                if (order === 0) return null;
                const key = ALL_KEYS.find(k => k.order === order);
                return key ? key.name.replace('F1-KEY-', '').replace('F2-KEY-', '').replace('F3-KEY-', '').replace('F4-KEY-', 'Key ') : `Order ${order}`;
            };
            
            const getRequiredKeyName = (order) => {
                if (order === 0) return null;
                const key = ALL_KEYS.find(k => k.order === order);
                return key ? key.name : `Key Lvl ${order}`;
            };

            const zonesAnalysis = useMemo(() => {
                return ZONES.map(z => {
                    const costR = z.usage * marketPrices.DOVR;
                    const costH = z.usage * marketPrices.DOVH;
                    const costF = z.usage * marketPrices.DOVF;
                    const costS = z.usage * marketPrices.DOVS;
                    
                    let totalCostWAX = 0;
                    if(z.entryCostDovX) {
                        totalCostWAX = z.entryCostDovX * marketPrices.DOVX;
                    } else {
                        totalCostWAX = costR + costH + costF + costS;
                    }
                    
                    const rewardWAX = z.win * marketPrices.DOVX;
                    const profitWAX = rewardWAX - totalCostWAX;
                    const profitUSD = profitWAX * waxPriceUsd;
                    const roi = totalCostWAX > 0 ? (profitWAX / totalCostWAX) * 100 : 0;
                    
                    const monthlyProfitWAX = profitWAX * 30;
                    const monthlyProfitUSD = profitUSD * 30;
                    
                    return { ...z, totalCostWAX, rewardWAX, profitWAX, profitUSD, monthlyProfitWAX, monthlyProfitUSD, roi };
                });
            }, [marketPrices, waxPriceUsd]);

            const advancedRoiAnalysis = useMemo(() => {
                const checkpoints = ZONES.filter(z => z.bonusToken);
                return checkpoints.map(z => {
                    const baseStats = zonesAnalysis.find(za => za.id === z.id);
                    let chestType = 'Bunker';
                    if (z.id === 8) chestType = 'Camp';
                    if (z.id === 12) chestType = 'Radar';
                    if (z.id === 16) chestType = 'HQ';
                    
                    let tokenValWax = 0;
                    if (z.id >= 17) {
                         tokenValWax = (baseStats.totalCostWAX * 0.25) + (z.minWeight * 0.1);
                    } else {
                         const estimatedChestVal = (baseStats.totalCostWAX * 27 * 0.25) + (z.minWeight * 2.7 * 0.1);
                         tokenValWax = estimatedChestVal / 27;
                    }
                    
                    const totalProfitWax = baseStats.profitWAX + tokenValWax;
                    const totalRoi = baseStats.totalCostWAX > 0 ? (totalProfitWax / baseStats.totalCostWAX) * 100 : 0;
                    return { ...baseStats, chestType: z.id>=17 ? 'Bridge' : chestType, tokenValWax, totalProfitWax, totalRoi, roiBoost: totalRoi - baseStats.roi };
                });
            }, [zonesAnalysis, chestEstimates]);

            const filteredAssetValuations = useMemo(() => {
                const buildings = productionAnalysis.map(b => {
                    let finalValWax = b.fairValueWax;
                    let premiumNote = "";
                    
                    // NEW LOGIC: CPU STAKING COST SAVINGS
                    if (b.accountsNeeded > 1) {
                         const savedAccounts = b.accountsNeeded - 1;
                         const cpuCapitalSaved = savedAccounts * cpuPerAccount;
                         
                         finalValWax += cpuCapitalSaved;
                         premiumNote = ` + Econ. CPU (${savedAccounts.toFixed(1)} cptes)`;
                    }

                    return {
                        name: b.name,
                        type: 'Bâtiment',
                        valueWax: finalValWax,
                        valueUsd: finalValWax * waxPriceUsd,
                        details: `Prod: ${(b.output * 24).toFixed(0)}/j | Eq: ${b.equivalentF1s.toFixed(1)} F1${premiumNote}`,
                        isSupreme: b.level === 5
                    };
                });

                const tokens = advancedRoiAnalysis.map(roi => ({
                    name: `Token ${roi.bonusToken.replace('TOKEN-', '')}`,
                    type: 'Token',
                    valueWax: roi.tokenValWax,
                    valueUsd: roi.tokenValWax * waxPriceUsd,
                    details: `Algo: Coût + Poids`
                }));

                const keys = ALL_KEYS.map(k => {
                    const targetZone = ZONES.find(z => z.keyReq === k.order);
                    let valWax = 0;
                    if (targetZone) {
                        const zoneStats = zonesAnalysis.find(z => z.id === targetZone.id);
                        if (zoneStats && zoneStats.profitWAX > 0) {
                            valWax = zoneStats.monthlyProfitWAX * 0.20; 
                        } else {
                             valWax = targetZone.minWeight * 0.5;
                        }
                    } 
                    return {
                        name: k.name,
                        type: 'Clé Tactique',
                        valueWax: valWax,
                        valueUsd: valWax * waxPriceUsd,
                        details: targetZone ? `Zone ${targetZone.name}` : 'Unlock'
                    };
                });
                
                const weightValueMultiplier = 0.1; 
                const units = UNITS.map(u => {
                    const dailyValue = u.baseWeight * weightValueMultiplier;
                    const valWax = dailyValue * roiTargetDays;
                    return {
                        name: u.name,
                        type: 'Unité',
                        valueWax: valWax,
                        valueUsd: valWax * waxPriceUsd,
                        details: `Poids: ${u.baseWeight}`
                    };
                });

                const allAssets = [...buildings, ...tokens, ...keys, ...units];

                if (valuationFilter === 'ALL') return allAssets;
                return allAssets.filter(a => {
                    if (valuationFilter === 'BUILDING') return a.type === 'Bâtiment';
                    if (valuationFilter === 'TOKEN') return a.type === 'Token';
                    if (valuationFilter === 'KEY') return a.type === 'Clé Tactique';
                    if (valuationFilter === 'UNIT') return a.type === 'Unité';
                    return true;
                });
            }, [productionAnalysis, advancedRoiAnalysis, zonesAnalysis, roiTargetDays, waxPriceUsd, valuationFilter, cpuPerAccount]);


            const accountSimStats = useMemo(() => {
                let totalProdWax = 0;
                let totalMaintWax = 0;
                
                accountBuildings.forEach(factoryId => {
                    const factory = productionAnalysis.find(f => f.id === factoryId);
                    if(factory) {
                        totalProdWax += factory.displayProdWax; 
                        totalMaintWax += factory.displayCostWax; 
                    }
                });

                let totalCombatEntryWax = 0;
                let totalCombatRewardWax = 0;
                let totalCombatTokenValueWax = 0;

                accountDivisions.forEach(zoneId => {
                    const zoneStats = advancedRoiAnalysis.find(z => z.id == zoneId) || zonesAnalysis.find(z => z.id == zoneId);
                    if(zoneStats) {
                         totalCombatEntryWax += zoneStats.totalCostWAX;
                         totalCombatRewardWax += zoneStats.rewardWAX;
                         if(zoneStats.tokenValWax) totalCombatTokenValueWax += zoneStats.tokenValWax;
                    }
                });

                const dailyNetProfitWax = (totalProdWax + totalCombatRewardWax + totalCombatTokenValueWax) - (totalMaintWax + totalCombatEntryWax);
                const dailyNetProfitUsd = dailyNetProfitWax * waxPriceUsd;

                // Ajout des calculs Mensuels et Annuels
                const monthlyNetProfitWax = dailyNetProfitWax * 30;
                const monthlyNetProfitUsd = monthlyNetProfitWax * waxPriceUsd;
                const yearlyNetProfitWax = dailyNetProfitWax * 365;
                const yearlyNetProfitUsd = yearlyNetProfitWax * waxPriceUsd;

                return {
                    totalProdWax, totalMaintWax,
                    totalCombatEntryWax, totalCombatRewardWax, totalCombatTokenValueWax,
                    dailyNetProfitWax, dailyNetProfitUsd,
                    monthlyNetProfitWax, monthlyNetProfitUsd,
                    yearlyNetProfitWax, yearlyNetProfitUsd
                };

            }, [accountBuildings, accountDivisions, productionAnalysis, zonesAnalysis, advancedRoiAnalysis, waxPriceUsd]);


            const selectedZone = ZONES.find(z => z.id === parseInt(selectedZoneId));
            const hasRequiredKey = useMemo(() => {
                if (selectedZone.keyReq === 0) return true;
                if (!selectedKey) return false;
                return selectedKey.order >= selectedZone.keyReq;
            }, [selectedZone, selectedKey]);
            
            const hasRequiredOfficer = useMemo(() => {
                if (selectedZone.specificOfficer) {
                    return selectedOfficer && selectedOfficer.id === selectedZone.specificOfficer;
                }
                const req = selectedZone.officerReq || 0;
                if (req === 0) return true;
                if (!selectedOfficer) return false;
                return selectedOfficer.order >= req;
            }, [selectedZone, selectedOfficer]);

            const hasRequiredGodmother = useMemo(() => {
                if (!selectedZone.godmotherReq) return true;
                return !!selectedGodmother;
            }, [selectedZone, selectedGodmother]);
            
            const missingUnits = useMemo(() => {
                if (!selectedZone.requiredUnits) return [];
                const missing = [];
                selectedZone.requiredUnits.forEach(reqId => {
                    const found = selectedSquad.find(u => u.id.startsWith(reqId));
                    if (!found) missing.push(reqId);
                });
                return missing;
            }, [selectedZone, selectedSquad]);


            const filteredUnits = useMemo(() => {
                if (unitRarityFilter === 'ALL') return userInventory.units;
                return userInventory.units.filter(u => u.rarity === unitRarityFilter);
            }, [userInventory.units, unitRarityFilter]);
            const squadStats = useMemo(() => {
                let totalBaseWeight = 0;
                let totalEffectiveWeight = 0;
                selectedSquad.forEach(unit => {
                    totalBaseWeight += unit.baseWeight;
                    const bonus = unit.bonuses[selectedZone.type] || 1.0;
                    totalEffectiveWeight += (unit.baseWeight * bonus);
                });
                let supportBonus = 0;
                if (selectedSupport) supportBonus = selectedSupport.bonusPct / 100;
                const finalWeight = totalEffectiveWeight * (1 + supportBonus);
                return { totalBaseWeight, totalEffectiveWeight, finalWeight, supportBonus };
            }, [selectedSquad, selectedZone, selectedSupport]);

            const combatROI = useMemo(() => {
                const costR = selectedZone.usage * marketPrices.DOVR;
                const costH = selectedZone.usage * marketPrices.DOVH;
                const costF = selectedZone.usage * marketPrices.DOVF;
                const costS = selectedZone.usage * marketPrices.DOVS;
                
                let totalCostWAX = 0;
                if (selectedZone.entryCostDovX) {
                    totalCostWAX = selectedZone.entryCostDovX * marketPrices.DOVX;
                } else {
                    totalCostWAX = costR + costH + costF + costS;
                }

                const rewardWAX = selectedZone.win * marketPrices.DOVX;
                const profitWAX = rewardWAX - totalCostWAX;
                const totalCostUsd = totalCostWAX * waxPriceUsd;
                const rewardUsd = rewardWAX * waxPriceUsd;
                const profitUsd = profitWAX * waxPriceUsd;
                const monthlyProfitWax = profitWAX * 30;
                const monthlyProfitUsd = profitUsd * 30;
                return { totalCostWAX, rewardWAX, profitWAX, totalCostUsd, rewardUsd, profitUsd, monthlyProfitWax, monthlyProfitUsd, roiPercent: totalCostWAX > 0 ? ((profitWAX / totalCostWAX) * 100).toFixed(2) : "0.00" };
            }, [selectedZone, marketPrices, waxPriceUsd]);

            const toggleUnit = (unit) => {
                if (selectedSquad.find(u => u.id === unit.id)) {
                    setSelectedSquad(selectedSquad.filter(u => u.id !== unit.id));
                } else {
                    if (selectedSquad.length < 10) setSelectedSquad([...selectedSquad, unit]);
                }
            };

            const handleAutoBuild = () => {
                const zone = ZONES.find(z => z.id === parseInt(selectedZoneId));
                if (!zone) return;
                
                if (zone.keyReq > 0) { const neededKey = userInventory.keys.find(k => k.order >= zone.keyReq); if (neededKey) setSelectedKey(neededKey); }
                
                if (zone.specificOfficer) {
                     const specOff = userInventory.officers.find(o => o.id === zone.specificOfficer);
                     if (specOff) setSelectedOfficer(specOff);
                } else {
                    const highestOfficer = [...userInventory.officers].sort((a, b) => b.order - a.order)[0];
                    if (highestOfficer) setSelectedOfficer(highestOfficer);
                }

                if (zone.godmotherReq) {
                    if (userInventory.godmothers.length > 0) setSelectedGodmother(userInventory.godmothers[0]);
                } else {
                    if (userInventory.godmothers.length > 0) setSelectedGodmother(userInventory.godmothers[0]);
                }

                const bestSupport = [...userInventory.supports].sort((a, b) => b.bonusPct - a.bonusPct)[0];
                if (bestSupport) setSelectedSupport(bestSupport);

                let newSquad = [];
                let currentSlots = 0;
                let currentWeight = 0;

                if (zone.unitReq) {
                    const prereqUnit = userInventory.units.find(u => u.baseId === zone.unitReq || u.id.startsWith(zone.unitReq));
                    if (prereqUnit) {
                        newSquad.push(prereqUnit);
                        const bonus = prereqUnit.bonuses[zone.type] || 0;
                        currentWeight += prereqUnit.baseWeight * bonus;
                        currentSlots++;
                    }
                }
                
                if (zone.requiredUnits) {
                    zone.requiredUnits.forEach(reqId => {
                         const unit = userInventory.units.find(u => u.baseId === reqId || u.id.startsWith(reqId));
                         if (unit && currentSlots < 10) {
                             newSquad.push(unit);
                             const bonus = unit.bonuses[zone.type] || 0;
                             currentWeight += unit.baseWeight * bonus;
                             currentSlots++; 
                         }
                    });
                }

                const candidates = userInventory.units.map(u => { const bonus = u.bonuses[zone.type] || 0; return { ...u, effectiveW: u.baseWeight * bonus }; });
                candidates.sort((a, b) => b.effectiveW - a.effectiveW);
                for (let unit of candidates) {
                    if (currentSlots >= 10) break;
                    if (unit.effectiveW <= 0.01) continue;
                    
                    if (currentWeight >= zone.minWeight * 1.05) break;
                    newSquad.push(unit);
                    currentWeight += unit.effectiveW;
                    currentSlots++;
                }
                setSelectedSquad(newSquad);
            };

            const switchToDetailMode = (zoneId) => {
                setSelectedZoneId(zoneId);
                setViewMode('builder');
                setSelectedSquad([]); setSelectedKey(null); setSelectedOfficer(null); setSelectedGodmother(null); setSelectedSupport(null);
            };

            return (
                <div className="p-4 md:p-8">
                <header className="flex flex-col xl:flex-row justify-between items-center mb-8 border-b border-slate-700 pb-4 gap-4">
                    <div className="flex items-center gap-3">
                        <div className="bg-blue-600 p-2 rounded-lg"><Shield size={32} className="text-white" /></div>
                        <div><h1 className="text-2xl font-bold tracking-wider text-white">DoV <span className="text-blue-400">COMMANDER</span> v3.4</h1><p className="text-slate-400 text-sm">Optimiseur Tactique & Financier</p></div>
                    </div>
                    <div className="flex flex-wrap gap-4 bg-slate-800 p-3 rounded-lg border border-slate-700 text-sm justify-center items-end">
                        <div className="flex flex-col"><span className="text-xs text-green-400 font-bold mb-1">Prix WAX ($)</span><div className="relative"><span className="absolute left-2 top-1.5 text-slate-500">$</span><input type="number" value={waxPriceUsd} step="0.001" onChange={(e) => handleGlobalWaxPriceChange(e.target.value)} className="bg-slate-700 text-white w-20 pl-5 pr-2 py-1 rounded border border-slate-600 focus:outline-none focus:border-blue-500"/></div></div>
                        <div className="w-px bg-slate-600 h-8 mx-2 hidden md:block self-center"></div>
                        <div className="flex flex-col"><span className="text-xs text-slate-400 mb-1">DOV-X (WAX)</span><input type="number" step="0.0001" value={dovxInputStr} onChange={(e) => handleManualDovxChange(e.target.value)} className="bg-slate-700 text-yellow-400 w-24 px-2 py-1 rounded border border-slate-600 focus:outline-none focus:border-blue-500"/></div>
                        <div className="flex flex-col w-32 md:w-48 px-2"><span className="text-[10px] text-blue-300 font-bold mb-1 flex justify-between"><span>SIMULATION DOVX</span><span>{marketPrices.DOVX.toFixed(3)}</span></span><input type="range" min="0" max="2" step="0.001" value={marketPrices.DOVX} onChange={handleSimulationSlider} className="accent-blue-500" /></div>
                        <div className="flex flex-col"><span className="text-xs text-slate-400 mb-1">Ressources (WAX)</span><input type="number" step="0.000001" value={tuInputStr} onChange={(e) => handleManualTuChange(e.target.value)} className="bg-slate-700 text-blue-400 w-24 px-2 py-1 rounded border border-slate-600 focus:outline-none focus:border-blue-500" /></div>
                        
                        {/* --- NOUVEAU PRIX ALCOR AJOUTÉ ICI --- */}
                        <DovxMarketPrice />
                        
                    </div>
                </header>
                
                {/* --- WAX MONITORING BAR --- */}
                <WaxMonitor />
                
                {/* --- NOUVELLE SECTION : LIENS OFFICIELS DOV --- */}
                <DovLinksSection />

                <div className="flex gap-4 mb-6 overflow-x-auto pb-2">
                    <button onClick={() => setActiveTab('account_sim')} className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all whitespace-nowrap ${activeTab === 'account_sim' ? 'bg-orange-600 text-white shadow-lg shadow-orange-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}><Briefcase size={18} /> 🏢 COMPTE COMPLET</button>
                    <button onClick={() => setActiveTab('combat')} className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all whitespace-nowrap ${activeTab === 'combat' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}><Crosshair size={18} /> COMBAT</button>
                    <button onClick={() => setActiveTab('production')} className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all whitespace-nowrap ${activeTab === 'production' ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}><FactoryIcon size={18} /> PRODUCTION</button>
                    <button onClick={() => setActiveTab('global_stats')} className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all whitespace-nowrap ${activeTab === 'global_stats' ? 'bg-orange-600 text-white shadow-lg shadow-orange-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}><Globe size={18} /> STATS GLOBALES</button>
                    <button onClick={() => setActiveTab('packs')} className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all whitespace-nowrap ${activeTab === 'packs' ? 'bg-purple-600 text-white shadow-lg shadow-purple-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}><Package size={18} /> PACKS</button>
                    <button onClick={() => setActiveTab('chests')} className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all whitespace-nowrap ${activeTab === 'chests' ? 'bg-yellow-600 text-white shadow-lg shadow-yellow-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}><Gift size={18} /> COFFRES</button>
                    <button onClick={() => setActiveTab('zone_roi_advanced')} className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all whitespace-nowrap ${activeTab === 'zone_roi_advanced' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}><Diamond size={18} /> ROI AVANCÉ (TOKENS)</button>
                    <button onClick={() => setActiveTab('valuation')} className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all whitespace-nowrap ${activeTab === 'valuation' ? 'bg-cyan-600 text-white shadow-lg shadow-cyan-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}><Scale size={18} /> VALORISATION ACTIFS</button>
                </div>

                {/* --- NOUVEL ONGLET: STATS GLOBALES (MACRO DASHBOARD) --- */}
                {activeTab === 'global_stats' && <MacroEconomicDashboard FACTORY_MAP={FACTORY_MAP} marketPrices={marketPrices} />}

                {/* --- TAB: ACCOUNT SIMULATOR (New) --- */}
                {activeTab === 'account_sim' && (
                    <div className="space-y-6">
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <Card>
                                <h3 className="text-lg font-bold text-orange-400 mb-4 flex items-center gap-2"><FactoryIcon size={20} /> Configuration Production (Max 4)</h3>
                                <div className="space-y-3">
                                    {accountBuildings.map((bId, idx) => (
                                        <div key={idx} className="flex gap-2 items-center">
                                            <span className="text-xs text-slate-500 w-6">#{idx+1}</span>
                                            <select 
                                                value={bId} 
                                                onChange={(e) => {
                                                    const newBuilds = [...accountBuildings];
                                                    newBuilds[idx] = e.target.value;
                                                    setAccountBuildings(newBuilds);
                                                }}
                                                className="flex-1 bg-slate-900 border border-slate-700 rounded p-2 text-sm focus:outline-none focus:border-orange-500"
                                            >
                                                {FACTORIES.map(f => (
                                                    <option key={f.id} value={f.id}>{f.name} (+{(f.output*24).toFixed(0)}/j)</option>
                                                ))}
                                            </select>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-4 pt-4 border-t border-slate-700 grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <div className="text-slate-400 text-xs">Production Brute /j</div>
                                        <div className="text-emerald-400 font-mono font-bold">
                                            {accountSimStats.totalProdWax.toFixed(2)} WAX
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-slate-400 text-xs">Coût Maintenance /j</div>
                                        <div className="text-red-400 font-mono font-bold">
                                            -{accountSimStats.totalMaintWax.toFixed(2)} WAX
                                        </div>
                                    </div>
                                </div>
                            </Card>

                            <Card>
                                <h3 className="text-lg font-bold text-blue-400 mb-4 flex items-center gap-2"><Crosshair size={20} /> Configuration Combat (3 Divisions)</h3>
                                <div className="space-y-3">
                                    {accountDivisions.map((zId, idx) => (
                                        <div key={idx} className="flex gap-2 items-center">
                                            <span className="text-xs text-slate-500 w-12">Div {idx+1}</span>
                                            <select 
                                                value={zId} 
                                                onChange={(e) => {
                                                    const newDivs = [...accountDivisions];
                                                    newDivs[idx] = parseInt(e.target.value);
                                                    setAccountDivisions(newDivs);
                                                }}
                                                className="flex-1 bg-slate-900 border border-slate-700 rounded p-2 text-sm focus:outline-none focus:border-blue-500"
                                            >
                                                {ZONES.map(z => (
                                                    <option key={z.id} value={z.id}>{z.name} (Win: {z.win})</option>
                                                ))}
                                            </select>
                                        </div>
                                    ))}
                                </div>
                                <div className="mt-4 pt-4 border-t border-slate-700 grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <div className="text-slate-400 text-xs">Coût Combats /j</div>
                                        <div className="text-red-400 font-mono font-bold">
                                            -{accountSimStats.totalCombatEntryWax.toFixed(2)} WAX
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-slate-400 text-xs">Gains (DOV-X + Tokens) /j</div>
                                        <div className="text-emerald-400 font-mono font-bold">
                                            +{(accountSimStats.totalCombatRewardWax + accountSimStats.totalCombatTokenValueWax).toFixed(2)} WAX
                                        </div>
                                    </div>
                                </div>
                            </Card>
                        </div>

                        <Card className="border-t-4 border-t-emerald-500 bg-slate-800/80">
                            <div className="text-center mb-2 text-emerald-400 font-bold tracking-widest text-sm uppercase">Bilan Consolidé (Profit Net)</div>
                            <div className="grid grid-cols-3 gap-4 text-center">
                                {/* Jour */}
                                <div className="p-2 bg-slate-900/50 rounded">
                                    <div className="text-xs text-slate-400 mb-1">PAR JOUR (NET)</div>
                                    <div className={`text-xl font-bold font-mono ${accountSimStats.dailyNetProfitWax > 0 ? "text-white" : "text-red-400"}`}>
                                        {accountSimStats.dailyNetProfitWax > 0 ? "+" : ""}{accountSimStats.dailyNetProfitWax.toFixed(2)} W
                                    </div>
                                    <div className="text-xs text-emerald-400">${accountSimStats.dailyNetProfitUsd.toFixed(2)}</div>
                                </div>
                                {/* Mois */}
                                <div className="p-2 bg-slate-900/50 rounded border border-slate-700">
                                    <div className="text-xs text-purple-300 mb-1">PAR MOIS (NET)</div>
                                    <div className={`text-xl font-bold font-mono ${accountSimStats.monthlyNetProfitWax > 0 ? "text-purple-100" : "text-red-400"}`}>
                                        {accountSimStats.monthlyNetProfitWax > 0 ? "+" : ""}{accountSimStats.monthlyNetProfitWax.toLocaleString(undefined, {maximumFractionDigits: 0})} W
                                    </div>
                                    <div className="text-xs text-emerald-400">${accountSimStats.monthlyNetProfitUsd.toFixed(2)}</div>
                                </div>
                                {/* Année */}
                                <div className="p-2 bg-slate-900/50 rounded">
                                    <div className="text-xs text-slate-400 mb-1">PAR AN (NET)</div>
                                    <div className={`text-xl font-bold font-mono ${accountSimStats.yearlyNetProfitWax > 0 ? "text-white" : "text-red-400"}`}>
                                        {accountSimStats.yearlyNetProfitWax > 0 ? "+" : ""}{accountSimStats.yearlyNetProfitWax.toLocaleString(undefined, {maximumFractionDigits: 0})} W
                                    </div>
                                    <div className="text-xs text-emerald-400">${accountSimStats.yearlyNetProfitUsd.toFixed(0)}</div>
                                </div>
                            </div>
                            <div className="mt-4 text-center text-[10px] text-slate-500 italic">
                                Formule : Production Brute - Maintenance - Coût Entrée + Rewards DOV-X + Valeur Tokens
                            </div>
                        </Card>
                    </div>
                )}

                {/* --- TAB: ZONE ROI ADVANCED --- */}
                {activeTab === 'zone_roi_advanced' && (
                    <div className="space-y-6">
                        <Card>
                            <h3 className="text-lg font-bold text-indigo-400 mb-6 flex items-center gap-2"><Diamond size={20} /> Rentabilité Avancée : Impact des Reward Tokens</h3>
                            <div className="p-4 bg-indigo-900/10 rounded border border-indigo-700/30 mb-6 text-sm text-indigo-200">
                                <p><strong>ℹ️ Note :</strong> La valeur des Tokens est désormais calculée <strong>dynamiquement</strong> par l'algorithme "Fair Value".</p>
                                <p className="mt-1 opacity-70">Formule : (Coût d'Entrée × 25%) + (Difficulté Poids × 0.1 WAX)</p>
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                                {['Bunker', 'Camp', 'Radar', 'HQ'].map(type => (
                                    <div key={type} className="bg-indigo-900/20 p-3 rounded border border-indigo-700/50">
                                        <label className="text-xs text-indigo-300 block mb-1">Val. Estimée Coffre {type} (WAX)</label>
                                        <input 
                                            type="number" 
                                            value={chestEstimates[type]}
                                            onChange={(e) => setChestEstimates({...chestEstimates, [type]: parseFloat(e.target.value) || 0})}
                                            className="w-full bg-slate-900 border border-indigo-600 rounded p-2 text-sm text-white font-bold focus:outline-none"
                                        />
                                        <div className="text-[10px] text-slate-500 mt-1">1 Token ≈ {(chestEstimates[type]/27).toFixed(2)} WAX</div>
                                    </div>
                                ))}
                            </div>

                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="text-slate-400 border-b border-slate-700 text-xs uppercase bg-slate-800/50">
                                            <th className="p-3">Zone Checkpoint</th>
                                            <th className="p-3 text-right">Coût Entrée</th>
                                            <th className="p-3 text-right">Gain DOV-X</th>
                                            <th className="p-3 text-right text-indigo-300">+ Gain Token (1u)</th>
                                            <th className="p-3 text-right font-bold text-white">Profit Net Total</th>
                                            <th className="p-3 text-center">ROI Boosté</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm">
                                        {advancedRoiAnalysis.map(z => (
                                            <tr key={z.id} className="border-b border-slate-700 hover:bg-slate-800/50 transition-colors">
                                                <td className="p-3 font-bold text-white">
                                                    <div>{z.name}</div>
                                                    <div className="text-[10px] text-slate-500 uppercase">{z.bonusToken.replace('TOKEN-', '')} TOKEN DROP</div>
                                                </td>
                                                <td className="p-3 text-right font-mono text-red-400">
                                                    -{z.totalCostWAX.toFixed(2)} W
                                                </td>
                                                <td className="p-3 text-right font-mono text-emerald-400">
                                                    +{z.rewardWAX.toFixed(2)} W
                                                </td>
                                                <td className="p-3 text-right font-mono text-indigo-300 bg-indigo-900/10">
                                                    +{z.tokenValWax.toFixed(2)} W
                                                </td>
                                                <td className="p-3 text-right font-mono font-bold">
                                                    <div className={z.totalProfitWax > 0 ? "text-emerald-400" : "text-red-400"}>
                                                        {z.totalProfitWax > 0 ? "+" : ""}{z.totalProfitWax.toFixed(2)} W
                                                    </div>
                                                    <div className="text-[10px] opacity-70">${(z.totalProfitWax * waxPriceUsd).toFixed(2)}</div>
                                                </td>
                                                <td className="p-3 text-center">
                                                    <div className={`px-2 py-1 rounded text-xs font-bold inline-block ${z.totalRoi > 0 ? "bg-emerald-900/50 text-emerald-300" : "bg-red-900/50 text-red-300"}`}>
                                                        {z.totalRoi.toFixed(1)}%
                                                    </div>
                                                    {z.roiBoost > 0 && <div className="text-[10px] text-indigo-400 mt-1">+{z.roiBoost.toFixed(1)}% boost</div>}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </Card>
                    </div>
                )}

                {/* --- TAB: VALUATION --- */}
                {activeTab === 'valuation' && (
                    <div className="space-y-6">
                        <Card>
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                <div>
                                    <h3 className="text-lg font-bold text-cyan-400 mb-1 flex items-center gap-2"><Scale size={20} /> Valorisation "Fair Value" des Actifs</h3>
                                    <p className="text-slate-400 text-sm">Calcul basé sur le rendement, l'économie de comptes (CPU Staking) et le temps gagné.</p>
                                </div>
                                <div className="flex flex-col items-end gap-2">
                                    <div className="flex items-center gap-2 bg-slate-900 p-2 rounded-lg border border-slate-700">
                                        <span className="text-xs text-slate-400">ROI Cible (Jours) :</span>
                                        <input 
                                            type="number" 
                                            value={roiTargetDays}
                                            onChange={(e) => setRoiTargetDays(parseInt(e.target.value) || 30)}
                                            className="w-16 bg-slate-800 border border-slate-600 rounded text-center text-sm focus:outline-none focus:border-cyan-500"
                                        />
                                    </div>
                                    <div className="flex items-center gap-2 bg-slate-900 p-2 rounded-lg border border-slate-700">
                                        <span className="text-xs text-slate-400">CPU par Compte (WAX) :</span>
                                        <input 
                                            type="number" 
                                            value={cpuPerAccount}
                                            onChange={(e) => setCpuPerAccount(parseInt(e.target.value) || 0)}
                                            className="w-16 bg-slate-800 border border-slate-600 rounded text-center text-sm focus:outline-none focus:border-cyan-500"
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            <div className="bg-blue-900/20 border border-blue-700/50 p-4 rounded mb-6 text-sm text-blue-200">
                                <h4 className="font-bold flex items-center gap-2 mb-2"><Info size={16}/> Notre Raisonnement de Valorisation</h4>
                                <ul className="list-disc pl-5 space-y-1 text-xs">
                                    <li><strong>Production :</strong> Le profit net généré sur la période cible (ex: 365 jours).</li>
                                    <li><strong>Gain de Temps :</strong> Prime pour les actifs qui condensent la puissance (ex: 1 F5 = 270 F1).</li>
                                    <li><strong>Économie de Capital (CPU) :</strong> Pour obtenir la même production qu'une usine suprême (F5) avec des usines communes (F1), il faudrait gérer ~67 comptes. Chaque compte nécessite de bloquer du WAX pour le CPU (ex: {cpuPerAccount} WAX). L'usine F5 économise ce capital bloqué.</li>
                                </ul>
                            </div>
                            
                            <div className="flex items-center gap-2 bg-slate-900 p-1 rounded-lg border border-slate-700 mb-4">
                                <button onClick={() => setValuationFilter('ALL')} className={`px-3 py-1 rounded text-xs font-bold transition-all ${valuationFilter === 'ALL' ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:text-white'}`}>TOUT</button>
                                <button onClick={() => setValuationFilter('BUILDING')} className={`px-3 py-1 rounded text-xs font-bold transition-all ${valuationFilter === 'BUILDING' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}>BÂTIMENTS</button>
                                <button onClick={() => setValuationFilter('TOKEN')} className={`px-3 py-1 rounded text-xs font-bold transition-all ${valuationFilter === 'TOKEN' ? 'bg-yellow-600 text-white' : 'text-slate-400 hover:text-white'}`}>TOKENS</button>
                                <button onClick={() => setValuationFilter('KEY')} className={`px-3 py-1 rounded text-xs font-bold transition-all ${valuationFilter === 'KEY' ? 'bg-purple-600 text-white' : 'text-slate-400 hover:text-white'}`}>CLÉS</button>
                                <button onClick={() => setValuationFilter('UNIT')} className={`px-3 py-1 rounded text-xs font-bold transition-all ${valuationFilter === 'UNIT' ? 'bg-emerald-600 text-white' : 'text-slate-400 hover:text-white'}`}>UNITÉS</button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                {/* LISTING */}
                                <div className="col-span-2">
                                    <div className="overflow-x-auto max-h-[600px]">
                                        <table className="w-full text-left border-collapse">
                                            <thead className="sticky top-0 bg-slate-800 z-10 shadow-lg">
                                                <tr className="text-slate-400 border-b border-slate-700 text-xs uppercase">
                                                    <th className="p-3">Nom de l'Actif</th>
                                                    <th className="p-3">Type</th>
                                                    <th className="p-3 text-right">Valeur Théorique (WAX)</th>
                                                    <th className="p-3 text-right">Valeur Théorique ($)</th>
                                                    <th className="p-3">Détails Calcul</th>
                                                </tr>
                                            </thead>
                                            <tbody className="text-sm">
                                                {filteredAssetValuations.map((asset, idx) => (
                                                    <tr key={idx} className="border-b border-slate-700 hover:bg-slate-700/30 transition-colors">
                                                        <td className="p-3 font-bold text-white flex items-center gap-2">
                                                            {asset.name}
                                                            {asset.isSupreme && <span className="bg-indigo-500 text-white text-[10px] px-1 rounded">💎 GAME CHANGER</span>}
                                                        </td>
                                                        <td className="p-3">
                                                            <span className={`px-2 py-1 rounded text-xs border ${
                                                                asset.type === 'Bâtiment' ? 'bg-blue-900/30 text-blue-300 border-blue-800' :
                                                                asset.type === 'Token' ? 'bg-yellow-900/30 text-yellow-300 border-yellow-800' :
                                                                asset.type === 'Clé Tactique' ? 'bg-purple-900/30 text-purple-300 border-purple-800' :
                                                                'bg-emerald-900/30 text-emerald-300 border-emerald-800'
                                                            }`}>
                                                                {asset.type}
                                                            </span>
                                                        </td>
                                                        <td className="p-3 text-right font-mono text-cyan-300 font-bold">{asset.valueWax.toLocaleString(undefined, {maximumFractionDigits: 0})} W</td>
                                                        <td className="p-3 text-right font-mono text-slate-300">${asset.valueUsd.toFixed(2)}</td>
                                                        <td className="p-3 text-xs text-slate-500 italic">{asset.details}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </Card>
                    </div>
                )}
                
                {/* COMBAT AND OTHER TABS RENDERED BELOW... */}
                {activeTab === 'combat' && (
                    <div>
                        {viewMode === 'dashboard' ? (
                            <div className="space-y-6">
                                <div className="flex bg-slate-800 p-1 rounded-lg border border-slate-700 w-fit">
                                    {[1, 2, 3].map(div => (<button key={div} onClick={() => setActiveDivision(div)} className={`px-4 py-2 rounded text-sm font-bold transition-all ${activeDivision === div ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>Division {div}</button>))}
                                </div>
                                <Card>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left border-collapse">
                                            <thead>
                                                <tr className="text-slate-400 border-b border-slate-700 text-xs uppercase bg-slate-800/50">
                                                    <th className="p-3">Zone</th><th className="p-3">Prérequis (Gatekeepers)</th><th className="p-3 text-right">Poids Min</th><th className="p-3 text-right">Coût Entrée</th><th className="p-3 text-right">Gain (Win)</th><th className="p-3 text-right">Profit Net / Combat</th><th className="p-3 text-right text-purple-300">Profit Net / Mois</th><th className="p-3 text-center">ROI</th><th className="p-3 text-center">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody className="text-sm">
                                                {zonesAnalysis.map(z => (
                                                    <tr key={z.id} className="border-b border-slate-700 hover:bg-slate-800/50 transition-colors">
                                                        <td className="p-3 font-bold text-white"><div>{z.name}</div><div className="text-[10px] text-slate-500 uppercase">{z.type}</div></td>
                                                        <td className="p-3">
                                                            <div className="flex gap-2 flex-wrap max-w-xs">
                                                                {z.keyReq > 0 && <div title={`Clé requise : ${getRequiredKeyName(z.keyReq)}`} className="flex items-center gap-1 bg-purple-900/40 text-purple-300 px-2 py-1 rounded text-xs border border-purple-800"><KeyIcon size={12}/> {getRequiredKeyName(z.keyReq).replace('F1-KEY-', '').replace('F2-KEY-', '').replace('F3-KEY-', '').replace('F4-KEY-', '')} ou +</div>}
                                                                {z.officerReq > 0 && <div title={`Officier Niveau ${z.officerReq} requis`} className="flex items-center gap-1 bg-blue-900/40 text-blue-300 px-2 py-1 rounded text-xs border border-blue-800"><Users size={12}/> Lvl {z.officerReq}</div>}
                                                                {z.godmotherReq && <div title="Godmother requise" className="flex items-center gap-1 bg-pink-900/40 text-pink-300 px-2 py-1 rounded text-xs border border-pink-800"><Heart size={12}/> GM</div>}
                                                                {z.unitReq && <div title="Unité Spéciale requise" className="flex items-center gap-1 bg-yellow-900/40 text-yellow-300 px-2 py-1 rounded text-xs border border-yellow-800"><Shield size={12}/> Unit</div>}
                                                                {z.requiredUnits && z.requiredUnits.length > 0 && <div title="Unités Spécifiques requises" className="flex items-center gap-1 bg-orange-900/40 text-orange-300 px-2 py-1 rounded text-xs border border-orange-800"><Shield size={12}/> {z.requiredUnits.length} Spec.</div>}
                                                                {z.keyReq===0 && z.officerReq===0 && <span className="text-slate-600 text-xs">- Aucun -</span>}
                                                            </div>
                                                        </td>
                                                        <td className="p-3 text-right font-mono text-slate-300">{z.minWeight}</td>
                                                        <td className="p-3 text-right font-mono text-red-400">
                                                            {z.totalCostWAX.toFixed(2)} W
                                                            <div className="text-[10px] opacity-70">${(z.totalCostWAX * waxPriceUsd).toFixed(2)}</div>
                                                            <div className="text-[10px] text-slate-400 mt-1">{z.entryCostDovX ? `${z.entryCostDovX.toLocaleString()} DOV-X` : `${z.usage.toLocaleString()} TU x4`}</div>
                                                        </td>
                                                        <td className="p-3 text-right font-mono text-emerald-400">
                                                            {z.rewardWAX.toFixed(2)} W
                                                            <div className="text-[10px] opacity-70">${(z.rewardWAX * waxPriceUsd).toFixed(2)}</div>
                                                            {z.bonusToken && <div title={`Bonus Token: ${z.bonusToken}`} className="text-[10px] text-yellow-500 mt-1">+ {z.bonusToken.replace('F1-TOKEN-', '')}</div>}
                                                        </td>
                                                        
                                                        {/* Profit / Combat */}
                                                        <td className="p-3 text-right font-bold font-mono">
                                                            <div className={z.profitWAX > 0 ? "text-emerald-500" : "text-red-500"}>
                                                                {z.profitWAX > 0 ? "+" : ""}{z.profitWAX.toFixed(2)} W
                                                            </div>
                                                            <div className="text-[10px] opacity-70">
                                                                ${z.profitUSD.toFixed(2)}
                                                            </div>
                                                        </td>

                                                        {/* Profit / Mois */}
                                                        <td className="p-3 text-right font-bold font-mono bg-slate-800/30">
                                                            <div className={z.monthlyProfitWAX > 0 ? "text-purple-400" : "text-red-400"}>
                                                                {z.monthlyProfitWAX > 0 ? "+" : ""}{z.monthlyProfitWAX.toLocaleString(undefined, {maximumFractionDigits: 0})} W
                                                            </div>
                                                            <div className="text-[10px] opacity-70">
                                                                ${z.monthlyProfitUSD.toFixed(2)}
                                                            </div>
                                                        </td>

                                                        <td className="p-3 text-center"><span className={`px-2 py-1 rounded text-xs font-bold ${z.roi > 0 ? "bg-emerald-900/50 text-emerald-300" : "bg-red-900/50 text-red-300"}`}>{z.roi.toFixed(1)}%</span></td>
                                                        <td className="p-3 text-center"><button onClick={() => switchToDetailMode(z.id)} className="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-xs flex items-center gap-1 mx-auto">PRÉPARER <ChevronRight size={12}/></button></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </Card>
                            </div>
                        ) : (
                            /* DETAIL BUILDER VIEW */
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="col-span-3 mb-2 flex items-center gap-4">
                                    <button onClick={() => setViewMode('dashboard')} className="flex items-center gap-2 text-slate-400 hover:text-white font-bold text-sm"><ArrowLeft size={16}/> Retour Tableau de Bord</button>
                                    <div className="h-6 w-px bg-slate-700"></div>
                                    <h2 className="text-xl font-bold text-white flex items-center gap-2"><Crosshair size={24} className="text-blue-500"/> Préparation : <span className="text-blue-400">{selectedZone.name}</span></h2>
                                </div>
                                <div className="space-y-6">
                                    <Card>
                                        <h3 className="text-lg font-bold text-yellow-300 mb-4 flex items-center gap-2"><Users size={20} /> État Major</h3>
                                        <div className="space-y-4">
                                            <div>
                                                <label className={`text-xs uppercase font-bold mb-1 flex items-center gap-1 ${selectedZone.officerReq > 0 ? (hasRequiredOfficer ? 'text-green-400' : 'text-red-400') : 'text-slate-400'}`}>Officier {selectedZone.officerReq > 0 ? `(Req Lvl ${selectedZone.officerReq})` : '(Optionnel)'}</label>
                                                {selectedZone.specificOfficer && <div className="text-[10px] text-orange-400 mb-1">Spécifique Requis : {selectedZone.specificOfficer}</div>}
                                                <select className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:outline-none focus:border-blue-500" onChange={(e) => setSelectedOfficer(userInventory.officers.find(o => o.id === e.target.value))} value={selectedOfficer?.id || ''}>
                                                    <option value="">-- Choisir Officier --</option>
                                                    {userInventory.officers.map(off => <option key={off.id} value={off.id}>{off.name} (Lvl {off.order})</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className={`text-xs uppercase font-bold mb-1 flex items-center gap-1 ${selectedZone.keyReq > 0 ? (hasRequiredKey ? 'text-green-400' : 'text-red-400') : 'text-purple-400'}`}>
                                                    <KeyIcon size={12}/> Slot Tactique {selectedZone.keyReq > 0 ? `(${getRequiredKeyName(selectedZone.keyReq)} ou +)` : '(Optionnel)'}
                                                </label>
                                                <select className="w-full bg-slate-900 border border-purple-500/50 rounded p-2 text-sm focus:outline-none focus:border-purple-500" onChange={(e) => setSelectedKey(userInventory.keys.find(k => k.id === e.target.value))} value={selectedKey?.id || ''}>
                                                    <option value="">-- Sélectionner Clé --</option>
                                                    {userInventory.keys.map(k => <option key={k.id} value={k.id}>{k.name} (Lvl {k.order})</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className={`text-xs uppercase font-bold mb-1 flex items-center gap-1 ${selectedZone.godmotherReq ? (hasRequiredGodmother ? 'text-green-400' : 'text-red-400') : 'text-pink-400'}`}><Heart size={12}/> Godmother {selectedZone.godmotherReq ? '(OBLIGATOIRE)' : '(Optionnel)'}</label>
                                                <select className="w-full bg-slate-900 border border-pink-500/50 rounded p-2 text-sm focus:outline-none focus:border-pink-500" onChange={(e) => setSelectedGodmother(userInventory.godmothers.find(k => k.id === e.target.value))} value={selectedGodmother?.id || ''}>
                                                    <option value="">-- Sélectionner Godmother --</option>
                                                    {userInventory.godmothers.map(k => <option key={k.id} value={k.id}>{k.name}</option>)}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-xs text-slate-400 uppercase font-bold mb-1 block">Support (Optionnel)</label>
                                                <select className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:outline-none focus:border-blue-500" onChange={(e) => setSelectedSupport(userInventory.supports.find(s => s.id === e.target.value))} value={selectedSupport?.id || ''}>
                                                    <option value="">-- Choisir Support --</option>
                                                    {userInventory.supports.map(sup => <option key={sup.id} value={sup.id}>{sup.name} (+{sup.bonusPct}%)</option>)}
                                                </select>
                                            </div>
                                        </div>
                                    </Card>
                                </div>
                                <div className="space-y-6">
                                    <Card className="h-full">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-lg font-bold text-emerald-300 flex items-center gap-2"><Shield size={20} /> Armée ({selectedSquad.length}/10)</h3>
                                        <div className="flex bg-slate-900 rounded p-1">
                                            {['ALL', 'Common', 'Uncommon', 'Rare', 'Epic', 'Legendary'].map(r => (
                                                <button key={r} onClick={() => setUnitRarityFilter(r)} className={`px-2 py-1 text-[10px] rounded ${unitRarityFilter === r ? 'bg-emerald-700 text-white' : 'text-slate-500 hover:text-white'}`}>{r.substring(0,3)}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <button onClick={handleAutoBuild} className="w-full mb-3 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-bold py-2 px-4 rounded shadow-lg flex items-center justify-center gap-2 text-sm"><Zap size={16} /> ⚡ AUTO-BUILD (OPTIMISÉ)</button>
                                    
                                    {selectedZone.requiredUnits && (
                                        <div className="mb-2 p-2 bg-orange-900/30 border border-orange-700/50 rounded text-xs text-orange-200">
                                            <div className="font-bold mb-1">Unités Spéciales Requises :</div>
                                            <div className="flex flex-wrap gap-1">
                                                {selectedZone.requiredUnits.map(req => (
                                                    <span key={req} className={`px-1 rounded ${missingUnits.includes(req) ? 'bg-red-500/50 text-white' : 'bg-green-500/50 text-white'}`}>{req}</span>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    <div className="space-y-3 max-h-[450px] overflow-y-auto pr-2">
                                        {filteredUnits.map(unit => {
                                        const bonus = unit.bonuses[selectedZone.type] || 0;
                                        const effectiveW = unit.baseWeight * bonus;
                                        const isSelected = !!selectedSquad.find(u => u.id === unit.id);
                                        return (
                                            <div key={unit.id} onClick={() => toggleUnit(unit)} className={`p-3 rounded border cursor-pointer transition-all relative ${isSelected ? 'bg-emerald-900/30 border-emerald-500' : 'bg-slate-900 border-slate-700 hover:border-slate-500'}`}>
                                            <div className="flex justify-between items-start">
                                                <div><div className="font-bold text-sm">{unit.name}</div><div className="text-xs text-slate-400">{unit.type} | {unit.rarity}</div></div>
                                                <div className="text-right">
                                                <div className={`font-mono font-bold ${bonus < 0.5 ? 'text-red-400' : bonus >= 1 ? 'text-emerald-400' : 'text-yellow-400'}`}>{effectiveW.toFixed(2)} pts</div>
                                                <div className="text-[10px] text-slate-500">Base: {unit.baseWeight.toFixed(1)} x {Math.round(bonus * 100)}%</div>
                                                </div>
                                            </div>
                                            {bonus < 0.5 && (<div className="absolute top-1 right-1"><AlertTriangle size={12} className="text-red-500" /></div>)}
                                            </div>
                                        );
                                        })}
                                    </div>
                                    </Card>
                                </div>
                                <div className="space-y-6">
                                    <Card className="border-t-4 border-t-blue-500">
                                    <h3 className="text-lg font-bold text-white mb-4">Analyse Tactique</h3>
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center border-b border-slate-700 pb-2"><span className="text-sm text-slate-400">Accès Zone (Key)</span>{hasRequiredKey ? <Badge color="green">AUTORISÉ</Badge> : <Badge color="red">VERROUILLÉ</Badge>}</div>
                                        <div className="flex justify-between items-center border-b border-slate-700 pb-2"><span className="text-sm text-slate-400">Commandement</span>{hasRequiredOfficer ? <Badge color="green">PRÊT</Badge> : <Badge color="red">OFFICIER REQUIS</Badge>}</div>
                                        <div className="flex justify-between items-center border-b border-slate-700 pb-2"><span className="text-sm text-slate-400">Godmother</span>{hasRequiredGodmother ? <Badge color="green">OK</Badge> : <Badge color="red">REQUISE</Badge>}</div>
                                        {selectedZone.requiredUnits && <div className="flex justify-between items-center border-b border-slate-700 pb-2"><span className="text-sm text-slate-400">Unités Spéciales</span>{missingUnits.length === 0 ? <Badge color="green">COMPLET</Badge> : <Badge color="red">MANQUANTES</Badge>}</div>}
                                        <div className="bg-slate-900 p-3 rounded border border-slate-700">
                                        <div className="flex justify-between text-sm mb-1"><span className="text-slate-400">Poids Requis (Win)</span><span className="font-mono text-white">{selectedZone.minWeight.toFixed(2)}</span></div>
                                        <div className="flex justify-between text-lg font-bold mb-2"><span className={squadStats.finalWeight >= selectedZone.minWeight ? "text-emerald-400" : "text-red-400"}>Puissance Totale</span><span className="font-mono text-white">{squadStats.finalWeight.toFixed(2)}</span></div>
                                        <div className="w-full bg-slate-700 h-2 rounded-full overflow-hidden"><div className={`h-full ${squadStats.finalWeight >= selectedZone.minWeight ? 'bg-emerald-500' : 'bg-red-500'}`} style={{ width: `${Math.min((squadStats.finalWeight / selectedZone.minWeight) * 100, 100)}%` }}></div></div>
                                        </div>
                                        <div className="mt-4 text-center">
                                        {!hasRequiredKey ? (<div className="p-3 bg-red-900/50 border border-red-500 rounded text-red-200 font-bold flex items-center justify-center gap-2"><Lock size={18} /> CLÉ TACTIQUE REQUISE</div>) : !hasRequiredOfficer ? (<div className="p-3 bg-red-900/50 border border-red-500 rounded text-red-200 font-bold flex items-center justify-center gap-2"><Users size={18} /> OFFICIER REQUIS</div>) : !hasRequiredGodmother ? (<div className="p-3 bg-red-900/50 border border-red-500 rounded text-red-200 font-bold flex items-center justify-center gap-2"><Heart size={18} /> GODMOTHER REQUISE</div>) : missingUnits.length > 0 ? (<div className="p-3 bg-red-900/50 border border-red-500 rounded text-red-200 font-bold flex items-center justify-center gap-2"><Shield size={18} /> UNITÉS MANQUANTES</div>) : squadStats.finalWeight >= selectedZone.minWeight ? (<div className="p-3 bg-emerald-900/50 border border-emerald-500 rounded text-emerald-200 font-bold flex items-center justify-center gap-2"><CheckCircle size={18} /> VICTOIRE ASSURÉE</div>) : (<div className="p-3 bg-red-900/50 border border-red-500 rounded text-red-200 font-bold flex items-center justify-center gap-2"><AlertTriangle size={18} /> DÉFAITE PROBABLE</div>)}
                                        </div>
                                    </Card>
                                    <Card className="border-t-4 border-t-yellow-500">
                                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><DollarSign size={20} /> Rentabilité / Combat</h3>
                                    <div className="space-y-3 text-sm">
                                        <div className="grid grid-cols-2 gap-4">
                                        <div><span className="text-slate-400 text-xs block">COÛT RESSOURCES</span><div className="text-red-400 font-mono">-{combatROI.totalCostWAX.toFixed(2)} WAX</div><div className="text-red-500/70 text-xs font-mono">(-${combatROI.totalCostUsd.toFixed(3)})</div><div className="text-[10px] text-slate-400 mt-1">{selectedZone.entryCostDovX ? `${selectedZone.entryCostDovX} DOV-X` : `${selectedZone.usage.toLocaleString()} TU x4`}</div></div>
                                        <div className="text-right"><span className="text-slate-400 text-xs block">GAIN DOV-X</span><div className="text-emerald-400 font-mono">+{combatROI.rewardWAX.toFixed(2)} WAX</div><div className="text-emerald-500/70 text-xs font-mono">(+${combatROI.rewardUsd.toFixed(3)})</div></div>
                                        </div>
                                        <div className="border-t border-slate-700 pt-2"><div className="flex justify-between items-baseline mb-1"><span className="font-bold text-slate-300">Profit Net</span><span className={`text-lg font-bold ${combatROI.profitWAX > 0 ? "text-emerald-400" : "text-red-400"}`}>{combatROI.profitWAX > 0 ? "+" : ""}{combatROI.profitWAX.toFixed(2)} WAX</span></div><div className={`text-right font-mono text-sm ${combatROI.profitUsd > 0 ? "text-emerald-500" : "text-red-500"}`}>{combatROI.profitUsd > 0 ? "+" : ""}${combatROI.profitUsd.toFixed(4)}</div></div>
                                        <div className="text-center bg-slate-900 rounded p-1 text-xs text-slate-500 mt-1">ROI: <span className={combatROI.roiPercent > 0 ? "text-green-400" : "text-slate-500"}>{combatROI.roiPercent}%</span></div>
                                    </div>
                                    </Card>
                                </div>
                            </div>
                        )}
                    </div>
                )}
                
                {/* PRODUCTION TAB */}
                {activeTab === 'production' && (
                    <div className="space-y-6">
                    <Card>
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div><h2 className="text-xl font-bold flex items-center gap-2 text-emerald-400"><FactoryIcon /> Analyse Rentabilité Usines</h2><p className="text-slate-400 text-sm mt-1">Comparez le coût de production vs prix d'achat Alcor.</p></div>
                        <div className="flex items-center gap-4"><div className="flex items-center gap-2 bg-slate-900 p-1 rounded-lg border border-slate-700"><button onClick={() => setTimeframe('day')} className={`px-3 py-1 rounded text-xs font-bold transition-all ${timeframe === 'day' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}>24H</button><button onClick={() => setTimeframe('month')} className={`px-3 py-1 rounded text-xs font-bold transition-all ${timeframe === 'month' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}>30 JOURS</button></div><div className="flex items-center gap-2 bg-slate-900 p-1 rounded-lg border border-slate-700 hidden md:flex"><Filter size={14} className="text-slate-500 ml-2" />{['ALL', 'FUEL', 'REPAIR', 'SUPPLY', 'HEALTH'].map(f => (<button key={f} onClick={() => setFactoryFilter(f)} className={`px-3 py-1 rounded text-xs font-bold transition-all ${factoryFilter === f ? 'bg-emerald-600 text-white' : 'text-slate-400 hover:text-white'}`}>{f}</button>))}</div></div>
                        </div>
                        <div className="overflow-x-auto max-h-[700px]"><table className="w-full text-left border-collapse"><thead className="sticky top-0 bg-slate-800 z-10 shadow-lg"><tr className="text-slate-400 border-b border-slate-700 text-xs uppercase"><th className="p-3">Usine</th><th className="p-3">Type</th><th className="p-3">Rareté</th><th className="p-3 text-right">Prod. Brute ({timeframe === 'day' ? '24h' : 'Mois'})</th><th className="p-3 text-right">Coût Unit (WAX)</th><th className="p-3 text-right text-emerald-300">Profit Net ($)</th><th className="p-3 text-center">Action</th></tr></thead><tbody className="overflow-y-auto">{filteredFactories.map(factory => (<tr key={factory.id} className="border-b border-slate-700 hover:bg-slate-700/30 transition-colors"><td className="p-3 font-bold text-white text-sm">{factory.name}</td><td className="p-3 text-xs text-slate-400">{factory.type}</td><td className="p-3"><Badge color={factory.rarity === 'Legendary' ? 'yellow' : factory.rarity === 'Epic' ? 'purple' : factory.rarity === 'Supreme' ? 'red' : 'blue'}>{factory.rarity} {factory.level < 5 ? `L${factory.level}` : ''}</Badge></td><td className="p-3 text-right font-mono text-emerald-400 text-sm">{factory.displayOutput.toLocaleString(undefined, {maximumFractionDigits: 0})}</td><td className="p-3 text-right font-mono text-sm"><div className={factory.betterToBuy ? "text-red-300" : "text-slate-300"}>{factory.unitCost.toFixed(6)}</div><div className="text-[10px] text-slate-500">Mkt: {factory.marketPrice.toFixed(6)}</div></td><td className="p-3 text-right font-mono text-sm font-bold"><div className={factory.displayProfitUsd > 0 ? "text-emerald-400" : "text-red-400"}>${factory.displayProfitUsd.toFixed(timeframe === 'day' ? 4 : 2)}</div><div className="text-[10px] text-slate-500">{factory.displayProfitWax.toFixed(2)} WAX</div></td><td className="p-3 text-center">{factory.betterToBuy ? (<div className="inline-flex items-center gap-1 text-red-400 font-bold bg-red-900/30 px-2 py-1 rounded text-xs"><AlertTriangle size={12} /> BUY</div>) : (<div className="inline-flex items-center gap-1 text-emerald-400 font-bold bg-emerald-900/30 px-2 py-1 rounded text-xs"><CheckCircle size={12} /> PROD</div>)}</td></tr>))}</tbody></table></div>
                    </Card>
                    </div>
                )}
                
                {/* PACKS TAB */}
                {activeTab === 'packs' && (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="space-y-6">
                            <Card>
                                <h3 className="text-lg font-bold text-purple-300 mb-4 flex items-center gap-2"><Package size={20} /> Configuration du Pack</h3>
                                <div className="space-y-4">
                                    <div><label className="text-xs text-slate-400 block mb-1">Nom du Pack</label><input type="text" value={packBuilder.name} onChange={(e) => setPackBuilder({...packBuilder, name: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:border-purple-500 outline-none" /></div>
                                    <div className="flex gap-4"><div className="flex-1"><label className="text-xs text-slate-400 block mb-1 font-bold text-purple-400">Prix du Pack ($)</label><div className="relative"><span className="absolute left-3 top-2 text-slate-400 font-bold">$</span><input type="number" step="0.01" value={packPriceUsdStr} onChange={(e) => handleUsdPriceChange(e.target.value)} className="w-full bg-slate-800 border-2 border-purple-600 rounded p-2 pl-6 text-lg font-bold text-white focus:outline-none" /></div></div><div className="flex-1"><label className="text-xs text-slate-400 block mb-1">Equivalent WAX</label><div className="relative"><input type="number" value={packBuilder.price.toFixed(2)} onChange={(e) => handleWaxPriceChange(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded p-2 pl-2 text-sm text-yellow-400 font-mono font-bold focus:border-purple-500 outline-none" /><span className="absolute right-3 top-2 text-xs text-slate-500">WAX</span></div></div></div>
                                    <div className="mt-2 bg-slate-800/50 p-2 rounded border border-slate-700/50"><label className="text-xs text-slate-400 block mb-1">Ou définir un Objectif ROI (Jours)</label><div className="relative"><input type="number" placeholder="Ex: 30" value={targetRoi} onChange={(e) => updatePriceFromRoi(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded p-2 pl-8 text-sm text-purple-300 focus:border-purple-500 outline-none" /><div className="absolute left-2 top-2 text-purple-500"><Calculator size={16}/></div></div></div>
                                    
                                    {/* AUTO GENERATOR */}
                                    <div className="mt-4 p-3 bg-purple-900/20 border border-purple-700/50 rounded-lg">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-xs font-bold text-purple-300 flex items-center gap-1"><Zap size={12}/> GÉNÉRATEUR AUTOMATIQUE</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 mb-2">
                                            <div>
                                                <label className="text-[10px] text-slate-400 block">Budget ($)</label>
                                                <input type="number" value={autoGenOptions.budget} onChange={(e) => setAutoGenOptions({...autoGenOptions, budget: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded p-1 text-xs" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] text-slate-400 block">ROI Cible (Jours)</label>
                                                <input type="number" value={autoGenOptions.roi} onChange={(e) => setAutoGenOptions({...autoGenOptions, roi: e.target.value})} className="w-full bg-slate-900 border border-slate-600 rounded p-1 text-xs" />
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-4 mb-3">
                                            <label className="flex items-center gap-1 text-[10px] text-slate-400 cursor-pointer">
                                                <input type="checkbox" checked={autoGenOptions.limit4} onChange={(e) => setAutoGenOptions({...autoGenOptions, limit4: e.target.checked})} className="rounded bg-slate-900 border-slate-600 text-purple-500 focus:ring-0" />
                                                Mode Starter (Max 4 Bât.)
                                            </label>
                                            <label className="flex items-center gap-1 text-[10px] text-slate-400 cursor-pointer">
                                                <input type="checkbox" checked={autoGenOptions.diverse} onChange={(e) => setAutoGenOptions({...autoGenOptions, diverse: e.target.checked})} className="rounded bg-slate-900 border-slate-600 text-purple-500 focus:ring-0" />
                                                Diversifier Types
                                            </label>
                                        </div>
                                        <button onClick={generateAutoPack} className="w-full bg-purple-700 hover:bg-purple-600 text-white py-1 rounded text-xs font-bold shadow-sm">
                                            GÉNÉRER PACK OPTIMISÉ
                                        </button>
                                    </div>
                                    
                                    <div className="border-t border-slate-700 pt-4"><label className="text-xs text-slate-400 block mb-2">Ajouter un Bâtiment</label><div className="flex gap-2"><select className="flex-1 bg-slate-900 border border-slate-600 rounded p-2 text-sm outline-none" value={selectedFactoryToAdd} onChange={(e) => setSelectedFactoryToAdd(e.target.value)}>{FACTORIES.map(f => (<option key={f.id} value={f.id}>{f.name} (Prod: {f.output * 24}/j)</option>))}</select><button onClick={addToPack} className="bg-purple-600 hover:bg-purple-500 text-white p-2 rounded"><Plus size={20} /></button></div></div>
                                </div>
                            </Card>
                            <Card className="min-h-[200px]">
                                <h3 className="text-sm font-bold text-slate-400 mb-2 uppercase">Contenu du Pack</h3>
                                {packBuilder.contents.length === 0 ? (<div className="text-slate-500 text-center py-8 text-sm italic">Aucun bâtiment ajouté.</div>) : (
                                    <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2">
                                        {packBuilder.contents.map((item, idx) => { 
                                            const factory = FACTORIES.find(f => f.id === item.factoryId);
                                            const dailyProd = factory.output * 24 * marketPrices[`DOV${factory.type.charAt(0)}`] * item.qty;
                                            const dailyCost = factory.costDoVX * 24 * marketPrices.DOVX * item.qty;
                                            const dailyNet = dailyProd - dailyCost;
                                            
                                            return ( 
                                                <div key={idx} className="bg-slate-900 p-2 rounded border border-slate-700 flex flex-col gap-2">
                                                    <div className="flex justify-between items-center">
                                                        <div className="flex-1">
                                                            <div className="text-sm font-bold">{factory.name}</div>
                                                            <div className="text-xs text-slate-500 flex gap-2"><span>{factory.rarity}</span><span className="text-slate-600">|</span><span>{factory.type}</span></div>
                                                        </div>
                                                        <div className="flex items-center gap-3">
                                                            <input type="number" min="1" value={item.qty} onChange={(e) => updatePackQty(item.factoryId, e.target.value)} className="w-12 bg-slate-800 border border-slate-600 rounded p-1 text-center text-sm" />
                                                            <button onClick={() => removeFromPack(item.factoryId)} className="text-red-500 hover:text-red-400"><Trash2 size={16} /></button>
                                                        </div>
                                                    </div>
                                                    {/* DETAIL LINE PER ITEM */}
                                                    <div className="flex justify-between text-[10px] bg-slate-800/50 p-1 rounded">
                                                        <span className="text-emerald-400">Prod Brut: {dailyProd.toFixed(2)} W</span>
                                                        <span className="text-red-400">Coût: {dailyCost.toFixed(2)} W</span>
                                                        <span className={dailyNet > 0 ? "text-emerald-300 font-bold" : "text-red-300 font-bold"}>Net: {dailyNet > 0 ? "+" : ""}{dailyNet.toFixed(2)} W</span>
                                                    </div>
                                                </div> 
                                            ); 
                                        })}
                                    </div>
                                )}
                            </Card>
                        </div>
                        {/* COLUMN 2: ANALYSIS */}
                        <div className="space-y-6">
                            <Card className="border-t-4 border-t-purple-500 h-full flex flex-col justify-between">
                                <div>
                                    <h3 className="text-lg font-bold text-white mb-6">Analyse de Rentabilité</h3>
                                    <div className="space-y-4 mb-8">
                                        <div className="flex justify-between items-center text-sm border-b border-slate-700 pb-2"><span className="text-slate-400">Investissement Total</span><div className="text-right"><div className="font-mono text-purple-400 text-xl font-bold">${(packBuilder.price * waxPriceUsd).toFixed(2)}</div><div className="text-xs text-yellow-500 font-mono">{packBuilder.price.toFixed(2)} WAX</div></div></div>
                                        
                                        <div className="grid grid-cols-2 gap-4"><div><div className="text-xs text-slate-500 mb-1">Production Brute / Jour</div><div className="text-emerald-400 font-mono font-bold">{packStats.totalDailyProdWax.toFixed(4)} WAX</div></div><div className="text-right"><div className="text-xs text-slate-500 mb-1">Coût Maintenance / Jour</div><div className="text-red-400 font-mono font-bold">{packStats.totalDailyCostWax.toFixed(4)} WAX</div></div></div>
                                        
                                        <div className="bg-slate-900 p-4 rounded border border-slate-700">
                                            <div className="text-center text-sm text-slate-400 mb-1">Profit Net Quotidien</div>
                                            <div className={`text-center text-2xl font-bold font-mono ${packStats.dailyNetWax > 0 ? 'text-emerald-400' : 'text-red-400'}`}>{packStats.dailyNetWax > 0 ? '+' : ''}{packStats.dailyNetWax.toFixed(4)} WAX</div>
                                            <div className="text-center text-sm text-emerald-500 mt-1 font-bold">≈ ${(packStats.dailyNetWax * waxPriceUsd).toFixed(4)} / jour</div>
                                        </div>

                                        {/* PROJECTIONS TABLE */}
                                        <div className="border border-slate-700 rounded overflow-hidden">
                                            <div className="bg-slate-800 px-3 py-1 text-xs font-bold text-slate-400 uppercase tracking-wide">Projections Financières (Net)</div>
                                            <table className="w-full text-xs text-right">
                                                <tbody>
                                                    <tr className="border-b border-slate-700/50 hover:bg-slate-800/30">
                                                        <td className="p-2 text-left text-slate-400">1 Mois (30j)</td>
                                                        <td className="p-2 text-emerald-400 font-mono font-bold">{packStats.monthlyNetWax.toFixed(2)} W</td>
                                                        <td className="p-2 text-slate-300 font-mono">${(packStats.monthlyNetWax * waxPriceUsd).toFixed(2)}</td>
                                                    </tr>
                                                    <tr className="border-b border-slate-700/50 hover:bg-slate-800/30">
                                                        <td className="p-2 text-left text-slate-400">1 An (365j)</td>
                                                        <td className="p-2 text-emerald-400 font-mono font-bold">{packStats.yearlyNetWax.toLocaleString(undefined, {maximumFractionDigits:0})} W</td>
                                                        <td className="p-2 text-slate-300 font-mono">${(packStats.yearlyNetWax * waxPriceUsd).toFixed(0)}</td>
                                                    </tr>
                                                    <tr className="bg-purple-900/20">
                                                        <td className="p-2 text-left text-purple-300 font-bold">Total sur ROI ({Math.ceil(packStats.roiDays)}j)</td>
                                                        <td className="p-2 text-purple-200 font-mono font-bold">{packStats.totalRoiPeriodWax.toFixed(2)} W</td>
                                                        <td className="p-2 text-purple-200 font-mono">${(packStats.totalRoiPeriodWax * waxPriceUsd).toFixed(2)}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>

                                    </div>
                                </div>
                                <div className="bg-gradient-to-r from-slate-800 to-slate-900 p-6 rounded-lg border border-slate-600 text-center">
                                    <div className="text-sm font-bold text-purple-300 uppercase tracking-wider mb-2">Retour sur Investissement</div>
                                    {packStats.dailyNetWax > 0 ? (
                                        <div>
                                            <div className="text-5xl font-bold text-white mb-2">{packStats.roiDays < 1 ? "< 1" : Math.ceil(packStats.roiDays)} <span className="text-xl font-normal text-slate-400">Jours</span></div>
                                            <div className="inline-block bg-emerald-900/50 text-emerald-400 px-3 py-1 rounded-full text-xs font-bold border border-emerald-700 mb-2">APR: {packStats.apr.toFixed(2)}% / an</div>
                                            <div className="text-xs text-slate-500">Pour rentabiliser vos ${(packBuilder.price * waxPriceUsd).toFixed(2)}</div>
                                        </div>
                                    ) : (
                                        <div className="text-red-400 font-bold flex flex-col items-center gap-2"><AlertTriangle size={32} /><span>JAMAIS RENTABLE</span><span className="text-xs font-normal text-slate-400">Les coûts de maintenance dépassent la production.</span></div>
                                    )}
                                </div>
                            </Card>
                        </div>
                    </div>
                )}
                
                {/* CHESTS TAB */}
                {activeTab === 'chests' && (
                    <div className="space-y-6">
                        <Card>
                            <h3 className="text-lg font-bold text-yellow-500 mb-4 flex items-center gap-2"><Gift size={20} /> Simulateur de Coffres & Drops</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="space-y-4">
                                    <div><label className="text-xs text-slate-400 uppercase font-bold mb-1 block">Type de Coffre</label><select className="w-full bg-slate-900 border border-yellow-600/50 rounded p-2 text-sm focus:outline-none focus:border-yellow-500 text-yellow-200 font-bold" value={selectedChestType} onChange={(e) => { setSelectedChestType(e.target.value); setChestSimulationResults(null); }}>{Object.keys(CHEST_DATA).map(type => (<option key={type} value={type}>{CHEST_DATA[type].name} (Zone {CHEST_DATA[type].zone})</option>))}</select></div>
                                    <div><label className="text-xs text-slate-400 uppercase font-bold mb-1 block">Quantité à ouvrir</label><div className="flex gap-2">{[1, 5, 10, 27, 50, 100].map(n => (<button key={n} onClick={() => setNumChestsToOpen(n)} className={`px-3 py-1 rounded text-xs font-bold transition-all ${numChestsToOpen === n ? 'bg-yellow-600 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'}`}>x{n}</button>))}<input type="number" min="1" value={numChestsToOpen} onChange={(e) => setNumChestsToOpen(parseInt(e.target.value) || 1)} className="w-16 bg-slate-900 border border-slate-600 rounded px-2 text-center text-sm focus:outline-none" /></div></div>
                                    <div className="bg-slate-900 p-3 rounded border border-slate-700 text-sm"><div className="flex justify-between mb-1"><span className="text-slate-400">Coût en Reward Tokens</span><span className="text-yellow-400 font-mono font-bold">{numChestsToOpen * 27} Tokens</span></div><div className="text-xs text-slate-500 italic">Basé sur le ratio de blend : 27 Tokens = 1 Coffre 4★</div></div>
                                    <button onClick={handleSimulateChests} className="w-full bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white font-bold py-3 px-4 rounded shadow-lg flex items-center justify-center gap-2"><Gift size={18} /> SIMULER OUVERTURE</button>
                                </div>
                                <div className="bg-slate-900/50 p-4 rounded border border-slate-700 h-full">
                                    {!chestSimulationResults ? (<div className="h-full flex flex-col justify-center items-center text-slate-500 text-center"><div className="mb-2 opacity-50"><Database size={48} /></div><p className="text-sm">Cliquez sur "Simuler Ouverture"<br/>pour générer les drops aléatoires.</p><div className="mt-4 text-xs text-slate-600 border-t border-slate-700 pt-2 w-full text-left"><div className="font-bold mb-1 uppercase">Probabilités Officielles :</div><div>• Bâtiments Communs/Rares/Epiques/Légendaires : ~25% chacun</div><div>• Jackpot F4 (T4) : 0.02% (Très Rare)</div><div>• Clés : ~33% chacune</div></div></div>) : (
                                        <div className="space-y-4 animate-fade-in">
                                            <div className="flex justify-between items-center border-b border-slate-700 pb-2"><h4 className="font-bold text-white">Résultats ({numChestsToOpen} Coffres)</h4><span className="text-xs text-emerald-400 bg-emerald-900/30 px-2 py-1 rounded">Succès</span></div>
                                            <div><div className="text-xs font-bold text-slate-400 uppercase mb-2 flex justify-between"><span>Bâtiments (100% Drop Rate)</span><span>{Object.values(chestSimulationResults.buildingDrops).reduce((a,b)=>a+b,0)} recus</span></div><div className="space-y-1 max-h-[150px] overflow-y-auto pr-2">{Object.entries(chestSimulationResults.buildingDrops).map(([name, count]) => { const isJackpot = name.includes('_F4_') || name.includes('L_F4') || name.includes('R_F4'); return ( <div key={name} className={`flex justify-between text-sm p-1 rounded ${isJackpot ? 'bg-yellow-900/40 border border-yellow-700/50' : 'hover:bg-slate-800'}`}><span className={isJackpot ? "text-yellow-200 font-bold" : "text-slate-300"}>{name} {isJackpot && "🌟"}</span><span className="font-mono font-bold text-white">x{count}</span></div> ) })}</div></div>
                                            <div><div className="text-xs font-bold text-slate-400 uppercase mb-2 flex justify-between"><span>Clés Tactiques (100% Drop Rate)</span><span>{Object.values(chestSimulationResults.keyDrops).reduce((a,b)=>a+b,0)} recus</span></div><div className="space-y-1">{Object.entries(chestSimulationResults.keyDrops).map(([name, count]) => ( <div key={name} className="flex justify-between text-sm p-1 hover:bg-slate-800 rounded"><span className="text-purple-300">{name}</span><span className="font-mono font-bold text-white">x{count}</span></div> ))}</div></div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </Card>
                    </div>
                )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DoVManager />);
    </script>
</body>
</html>
