<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoV Tactical Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICONS ---
        const Shield = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        );
        const FactoryIcon = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></svg>
        );
        const Crosshair = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg>
        );
        const TrendingUp = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
        );
        const AlertTriangle = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        );
        const CheckCircle = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        );
        const Lock = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        );
        const Users = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        );
        const ChevronRight = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"/></svg>
        );
        const DollarSign = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        );
        const Filter = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
        );
        const Calendar = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        );
        const Sliders = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
        );
        const Package = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m16.5 9.4-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
        );
        const Trash2 = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
        );
        const Plus = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        );
        const Calculator = ({size=20, className=""}) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
        );

        // --- DATASETS ---

        const INITIAL_MARKET_PRICES = {
            WAX: 1, 
            DOVX: 0.00528552,
            DOVR: 0.00045262,
            DOVH: 0.00045262,
            DOVF: 0.00045262,
            DOVS: 0.00045262,
        };

        const generateFactories = () => {
            const types = ['FUEL', 'REPAIR', 'SUPPLY', 'HEALTH'];
            const rarities = [
                { name: 'Common', levels: [
                { l: 1, out: 5.40, cost: 0.4590 },
                { l: 2, out: 12.15, cost: 1.0328 },
                { l: 3, out: 30.38, cost: 2.5819 },
                { l: 4, out: 83.53, cost: 7.1002 },
                { l: 5, out: 1458.00, cost: 123.9300 }
                ]},
                { name: 'Rare', levels: [
                { l: 1, out: 16.20, cost: 1.3770 },
                { l: 2, out: 36.45, cost: 3.0983 },
                { l: 3, out: 91.13, cost: 7.7456 },
                { l: 4, out: 250.59, cost: 21.3005 }
                ]},
                { name: 'Epic', levels: [
                { l: 1, out: 48.60, cost: 4.1310 },
                { l: 2, out: 109.35, cost: 9.2948 },
                { l: 3, out: 273.38, cost: 23.2369 },
                { l: 4, out: 751.78, cost: 63.9014 }
                ]},
                { name: 'Legendary', levels: [
                { l: 1, out: 145.80, cost: 12.3930 },
                { l: 2, out: 328.05, cost: 27.8843 },
                { l: 3, out: 820.13, cost: 69.7106 },
                { l: 4, out: 2255.34, cost: 191.7042 }
                ]},
                { name: 'Supreme', levels: [
                { l: 1, out: 2255.34, cost: 191.7042 }
                ]}
            ];

            let list = [];
            types.forEach(type => {
                rarities.forEach(rarity => {
                rarity.levels.forEach(level => {
                    if (level.l === 5 && (type === 'SUPPLY' || type === 'HEALTH')) return; 
                    list.push({
                    id: `${rarity.name.charAt(0)}_${type.charAt(0)}${level.l}`,
                    name: `${rarity.name} ${type} L${level.l}`,
                    type: type,
                    rarity: rarity.name,
                    level: level.l,
                    output: level.out,
                    costDoVX: level.cost
                    });
                });
                });
            });
            return list;
        };

        const FACTORIES = generateFactories();

        const ZONES = [
            // --- BEACH (Plage) ---
            { id: 1, name: 'Beach 1', type: 'Beach', order: 1, win: 400, usage: 1160, minWeight: 14, keyReq: 0 },
            { id: 2, name: 'Beach 2', type: 'Beach', order: 2, win: 2405, usage: 6968, minWeight: 28, keyReq: 2 },
            { id: 3, name: 'Beach 3', type: 'Beach', order: 3, win: 3037, usage: 8800, minWeight: 55, keyReq: 3 },
            { id: 4, name: 'Bunker (Beach End)', type: 'Beach', order: 4, win: 3838, usage: 11120, minWeight: 109, keyReq: 4, isCheckpoint: true },
            
            // --- FOREST (Forêt) ---
            { id: 5, name: 'Forest 1', type: 'Forest', order: 5, win: 4840, usage: 14024, minWeight: 219, keyReq: 5 },
            { id: 6, name: 'Forest 2', type: 'Forest', order: 6, win: 6110, usage: 17704, minWeight: 342, keyReq: 6 },
            { id: 7, name: 'Forest 3', type: 'Forest', order: 7, win: 7714, usage: 22352, minWeight: 450, keyReq: 7 },
            { id: 8, name: 'Camp (Forest End)', type: 'Forest', order: 8, win: 9739, usage: 28220, minWeight: 512, keyReq: 8, isCheckpoint: true },
            
            // --- HILL (Colline) ---
            { id: 9, name: 'Hill 1', type: 'Hill', order: 9, win: 12788, usage: 37052, minWeight: 695, keyReq: 9 },
            { id: 10, name: 'Hill 2', type: 'Hill', order: 10, win: 16791, usage: 48652, minWeight: 869, keyReq: 10 },
            { id: 11, name: 'Hill 3', type: 'Hill', order: 11, win: 22266, usage: 64516, minWeight: 1086, keyReq: 11 },
            { id: 12, name: 'Radar (Hill End)', type: 'Hill', order: 12, win: 29236, usage: 84712, minWeight: 1358, keyReq: 12, isCheckpoint: true },
            
            // --- PLAIN (Plaine) ---
            { id: 13, name: 'Plain 1', type: 'Plain', order: 13, win: 34300, usage: 99384, minWeight: 1697, keyReq: 13 },
            { id: 14, name: 'Plain 2', type: 'Plain', order: 14, win: 43385, usage: 125708, minWeight: 1866, keyReq: 14 },
            { id: 15, name: 'Plain 3', type: 'Plain', order: 15, win: 52171, usage: 151164, minWeight: 2052, keyReq: 15 },
            { id: 16, name: 'HQ (Plain End)', type: 'Plain', order: 16, win: 64884, usage: 188000, minWeight: 2495, keyReq: 16, isCheckpoint: true },
        ];

        const UNITS = [
            { id: 'u1', name: '26th Infantry (Common)', type: 'Infantry', baseWeight: 0.3, bonuses: { Beach: 1.0, Plain: 0.22, Forest: 1.0, Hill: 0.72, City: 0.01 } },
            { id: 'u2', name: '741st Tank (Epic)', type: 'Tank', baseWeight: 58.42, bonuses: { Beach: 0.22, Plain: 1.0, Forest: 0.22, Hill: 0.72, City: 0.01 } },
            { id: 'u3', name: 'Mosquito B.IV (Uncommon)', type: 'Plane', baseWeight: 0.9, bonuses: { Beach: 1.0, Plain: 0.22, Forest: 1.0, Hill: 0.72, City: 1.0 } },
            { id: 'u4', name: 'USS Arkansas (Legendary)', type: 'Ship', baseWeight: 1555.20, bonuses: { Beach: 0.22, Plain: 0.22, Forest: 0.22, Hill: 0.22, City: 1.0 } },
            { id: 'u5', name: '37th Engineer (Epic)', type: 'Engineer', baseWeight: 58.42, bonuses: { Beach: 1.0, Plain: 0.22, Forest: 1.0, Hill: 1.0, City: 0.01 } }
        ];

        const MOCK_INVENTORY = {
            keys: [
                { id: 'k1', name: 'F1-KEY-BEACH', order: 4 },
                { id: 'k2', name: 'F1-KEY-FOREST', order: 8 },
            ],
            officers: [
                { id: 'o1', name: 'F1-COLONEL-JOHN-F-R-SEITZ', order: 5 },
                { id: 'o2', name: 'F1-MAJOR-GENERAL-WHAOU', order: 20 },
            ],
            supports: [
                { id: 's1', name: 'F1-ASPIRANT-KIYO', bonusPct: 12.0 },
                { id: 's2', name: 'F4-104th-MEDICAL-BATTALION', bonusPct: 10.0 },
            ],
            units: UNITS 
        };

        // --- COMPONENTS ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-slate-800 border border-slate-700 rounded-lg p-4 shadow-xl ${className}`}>
                {children}
            </div>
        );

        const Badge = ({ children, color = "blue" }) => {
            const colors = {
                blue: "bg-blue-900 text-blue-200 border-blue-700",
                green: "bg-emerald-900 text-emerald-200 border-emerald-700",
                red: "bg-red-900 text-red-200 border-red-700",
                yellow: "bg-yellow-900 text-yellow-200 border-yellow-700",
                purple: "bg-purple-900 text-purple-200 border-purple-700",
                slate: "bg-slate-700 text-slate-300 border-slate-600",
            };
            return (
                <span className={`px-2 py-1 rounded text-xs font-bold border ${colors[color] || colors.blue}`}>
                    {children}
                </span>
            );
        };

        // --- APP MAIN ---

        function DoVManager() {
            const [activeTab, setActiveTab] = useState('combat');
            const [marketPrices, setMarketPrices] = useState(INITIAL_MARKET_PRICES);
            const [waxPriceUsd, setWaxPriceUsd] = useState(0.008); 
            const [userInventory, setUserInventory] = useState(MOCK_INVENTORY);
            const [factoryFilter, setFactoryFilter] = useState('ALL');
            const [timeframe, setTimeframe] = useState('day'); // 'day' | 'month'
            const [tuRatio, setTuRatio] = useState(INITIAL_MARKET_PRICES.DOVF / INITIAL_MARKET_PRICES.DOVX);

            // Pack Builder State
            const [packBuilder, setPackBuilder] = useState({
                name: 'Pack Personnalisé',
                price: 100, // WAX
                contents: [] // { factoryId: string, qty: number }
            });
            const [selectedFactoryToAdd, setSelectedFactoryToAdd] = useState(FACTORIES[0].id);
            const [targetRoi, setTargetRoi] = useState('');

            // State Combat
            const [selectedZoneId, setSelectedZoneId] = useState(1);
            const [selectedSquad, setSelectedSquad] = useState([]);
            const [selectedSupport, setSelectedSupport] = useState(null);
            const [selectedOfficer, setSelectedOfficer] = useState(null);

            // -- HANDLERS FOR SIMULATION --
            
            const handleSimulationSlider = (e) => {
                const newDovx = parseFloat(e.target.value);
                setMarketPrices({
                    ...marketPrices,
                    DOVX: newDovx,
                    // Link TUs to DOVX based on current ratio
                    DOVF: newDovx * tuRatio,
                    DOVR: newDovx * tuRatio,
                    DOVS: newDovx * tuRatio,
                    DOVH: newDovx * tuRatio
                });
            };

            const handleManualDovxChange = (val) => {
                const newDovx = parseFloat(val);
                setMarketPrices({...marketPrices, DOVX: newDovx});
                if(newDovx > 0) setTuRatio(marketPrices.DOVF / newDovx);
            };

            const handleManualTuChange = (val) => {
                const newTu = parseFloat(val);
                setMarketPrices({
                    ...marketPrices, 
                    DOVF: newTu, DOVR: newTu, DOVS: newTu, DOVH: newTu
                });
                if(marketPrices.DOVX > 0) setTuRatio(newTu / marketPrices.DOVX);
            };

            // -- PACK BUILDER HANDLERS --
            const addToPack = () => {
                const existing = packBuilder.contents.find(i => i.factoryId === selectedFactoryToAdd);
                if (existing) {
                    setPackBuilder({
                        ...packBuilder,
                        contents: packBuilder.contents.map(i => i.factoryId === selectedFactoryToAdd ? {...i, qty: i.qty + 1} : i)
                    });
                } else {
                    setPackBuilder({
                        ...packBuilder,
                        contents: [...packBuilder.contents, { factoryId: selectedFactoryToAdd, qty: 1 }]
                    });
                }
            };

            const removeFromPack = (id) => {
                setPackBuilder({
                    ...packBuilder,
                    contents: packBuilder.contents.filter(i => i.factoryId !== id)
                });
            };

            const updatePackQty = (id, newQty) => {
                if (newQty < 1) return;
                setPackBuilder({
                    ...packBuilder,
                    contents: packBuilder.contents.map(i => i.factoryId === id ? {...i, qty: parseInt(newQty)} : i)
                });
            };

            // Fonction pour calculer le prix à partir du ROI cible
            const updatePriceFromRoi = (daysStr) => {
                setTargetRoi(daysStr);
                const days = parseFloat(daysStr);
                if (!days || days <= 0) return;

                let totalDailyProdWax = 0;
                let totalDailyCostWax = 0;

                packBuilder.contents.forEach(item => {
                    const factory = FACTORIES.find(f => f.id === item.factoryId);
                    if (!factory) return;
                    
                    const resPrice = marketPrices[`DOV${factory.type.charAt(0)}`];
                    const dovxPrice = marketPrices.DOVX;
                    
                    const prod = factory.output * 24 * resPrice * item.qty;
                    const cost = factory.costDoVX * 24 * dovxPrice * item.qty;
                    
                    totalDailyProdWax += prod;
                    totalDailyCostWax += cost;
                });

                const dailyNetWax = totalDailyProdWax - totalDailyCostWax;
                
                // Si profit positif, on peut calculer un prix
                if (dailyNetWax > 0) {
                    const newPrice = dailyNetWax * days;
                    setPackBuilder(prev => ({...prev, price: parseFloat(newPrice.toFixed(2))}));
                }
            };

            const packStats = useMemo(() => {
                let totalDailyProdWax = 0;
                let totalDailyCostWax = 0;

                packBuilder.contents.forEach(item => {
                    const factory = FACTORIES.find(f => f.id === item.factoryId);
                    if (!factory) return;
                    
                    const resPrice = marketPrices[`DOV${factory.type.charAt(0)}`];
                    const dovxPrice = marketPrices.DOVX;
                    
                    const prod = factory.output * 24 * resPrice * item.qty;
                    const cost = factory.costDoVX * 24 * dovxPrice * item.qty;
                    
                    totalDailyProdWax += prod;
                    totalDailyCostWax += cost;
                });

                const dailyNetWax = totalDailyProdWax - totalDailyCostWax;
                const roiDays = dailyNetWax > 0 ? (packBuilder.price / dailyNetWax) : 0;

                return { totalDailyProdWax, totalDailyCostWax, dailyNetWax, roiDays };
            }, [packBuilder, marketPrices]);


            // --- LOGIC: PRODUCTION ---
            const productionAnalysis = useMemo(() => {
                return FACTORIES.map(factory => {
                    // Calculs 24h (Daily)
                    const dailyProdWax = factory.output * 24 * marketPrices[`DOV${factory.type.charAt(0)}`]; 
                    const dailyCostWax = factory.costDoVX * 24 * marketPrices.DOVX;
                    const dailyProfitWax = dailyProdWax - dailyCostWax;
                    const dailyProfitUsd = dailyProfitWax * waxPriceUsd;

                    // Calculs 30j (Monthly)
                    const monthlyProdWax = dailyProdWax * 30;
                    const monthlyCostWax = dailyCostWax * 30;
                    const monthlyProfitWax = dailyProfitWax * 30;
                    const monthlyProfitUsd = dailyProfitUsd * 30;

                    const unitCost = (factory.costDoVX * marketPrices.DOVX) / factory.output;
                    const marketPrice = marketPrices[`DOV${factory.type.charAt(0)}`];
                    
                    return { 
                        ...factory, 
                        
                        // Valeurs dynamiques selon timeframe
                        displayProdWax: timeframe === 'day' ? dailyProdWax : monthlyProdWax,
                        displayCostWax: timeframe === 'day' ? dailyCostWax : monthlyCostWax,
                        displayProfitWax: timeframe === 'day' ? dailyProfitWax : monthlyProfitWax,
                        displayProfitUsd: timeframe === 'day' ? dailyProfitUsd : monthlyProfitUsd,
                        displayOutput: timeframe === 'day' ? (factory.output * 24) : (factory.output * 24 * 30),
                        displayCostDoVX: timeframe === 'day' ? (factory.costDoVX * 24) : (factory.costDoVX * 24 * 30),

                        unitCost, 
                        marketPrice, 
                        isProfitable: dailyProfitWax > 0, 
                        betterToBuy: unitCost > marketPrice 
                    };
                });
            }, [marketPrices, waxPriceUsd, timeframe]);

            const filteredFactories = useMemo(() => {
                if (factoryFilter === 'ALL') return productionAnalysis;
                return productionAnalysis.filter(f => f.type === factoryFilter);
            }, [productionAnalysis, factoryFilter]);

            // --- LOGIC: COMBAT ---
            const selectedZone = ZONES.find(z => z.id === parseInt(selectedZoneId));

            const hasRequiredKey = useMemo(() => {
                if (selectedZone.keyReq === 0) return true;
                return userInventory.keys.some(k => k.order >= selectedZone.keyReq);
            }, [selectedZone, userInventory]);

            const hasOfficer = !!selectedOfficer; 

            const squadStats = useMemo(() => {
                let totalBaseWeight = 0;
                let totalEffectiveWeight = 0;

                selectedSquad.forEach(unit => {
                totalBaseWeight += unit.baseWeight;
                const bonus = unit.bonuses[selectedZone.type] || 1.0;
                totalEffectiveWeight += (unit.baseWeight * bonus);
                });

                let supportBonus = 0;
                if (selectedSupport) {
                supportBonus = selectedSupport.bonusPct / 100;
                }
                
                const finalWeight = totalEffectiveWeight * (1 + supportBonus);
                return { totalBaseWeight, totalEffectiveWeight, finalWeight, supportBonus };
            }, [selectedSquad, selectedZone, selectedSupport]);

            // ROI Combat
            const combatROI = useMemo(() => {
                const costR = selectedZone.usage * marketPrices.DOVR;
                const costH = selectedZone.usage * marketPrices.DOVH;
                const costF = selectedZone.usage * marketPrices.DOVF;
                const costS = selectedZone.usage * marketPrices.DOVS;
                
                const totalCostWAX = costR + costH + costF + costS;
                const rewardWAX = selectedZone.win * marketPrices.DOVX;
                const profitWAX = rewardWAX - totalCostWAX;
                
                // Conversion USD
                const totalCostUsd = totalCostWAX * waxPriceUsd;
                const rewardUsd = rewardWAX * waxPriceUsd;
                const profitUsd = profitWAX * waxPriceUsd;

                // Monthly Projection (30 fights)
                const monthlyProfitWax = profitWAX * 30;
                const monthlyProfitUsd = profitUsd * 30;
                
                return { 
                    totalCostWAX, rewardWAX, profitWAX, 
                    totalCostUsd, rewardUsd, profitUsd,
                    monthlyProfitWax, monthlyProfitUsd,
                    roiPercent: totalCostWAX > 0 ? ((profitWAX / totalCostWAX) * 100).toFixed(2) : "0.00" 
                };
            }, [selectedZone, marketPrices, waxPriceUsd]);


            const toggleUnit = (unit) => {
                if (selectedSquad.find(u => u.id === unit.id)) {
                setSelectedSquad(selectedSquad.filter(u => u.id !== unit.id));
                } else {
                setSelectedSquad([...selectedSquad, unit]);
                }
            };

            return (
                <div className="p-4 md:p-8">
                
                {/* HEADER */}
                <header className="flex flex-col xl:flex-row justify-between items-center mb-8 border-b border-slate-700 pb-4 gap-4">
                    <div className="flex items-center gap-3">
                    <div className="bg-blue-600 p-2 rounded-lg">
                        <Shield size={32} className="text-white" />
                    </div>
                    <div>
                        <h1 className="text-2xl font-bold tracking-wider text-white">DoV <span className="text-blue-400">COMMANDER</span></h1>
                        <p className="text-slate-400 text-sm">Optimiseur Tactique & Financier</p>
                    </div>
                    </div>
                    
                    {/* MARKET BAR & SIMULATION */}
                    <div className="flex flex-wrap gap-4 bg-slate-800 p-3 rounded-lg border border-slate-700 text-sm justify-center items-end">
                        
                        {/* WAX PRICE */}
                        <div className="flex flex-col">
                            <span className="text-xs text-green-400 font-bold mb-1">Prix WAX ($)</span>
                            <div className="relative">
                            <span className="absolute left-2 top-1.5 text-slate-500">$</span>
                            <input 
                                type="number" 
                                value={waxPriceUsd}
                                step="0.001"
                                onChange={(e) => setWaxPriceUsd(parseFloat(e.target.value))}
                                className="bg-slate-700 text-white w-20 pl-5 pr-2 py-1 rounded border border-slate-600 focus:outline-none focus:border-blue-500"
                            />
                            </div>
                        </div>
                        
                        <div className="w-px bg-slate-600 h-8 mx-2 hidden md:block self-center"></div>

                        {/* DOVX MANUAL */}
                        <div className="flex flex-col">
                            <span className="text-xs text-slate-400 mb-1">DOV-X (WAX)</span>
                            <input 
                            type="number" 
                            step="0.0001"
                            value={marketPrices.DOVX}
                            onChange={(e) => handleManualDovxChange(e.target.value)}
                            className="bg-slate-700 text-yellow-400 w-24 px-2 py-1 rounded border border-slate-600 focus:outline-none focus:border-blue-500"
                            />
                        </div>

                        {/* SLIDER SIMULATION */}
                        <div className="flex flex-col w-32 md:w-48 px-2">
                            <span className="text-[10px] text-blue-300 font-bold mb-1 flex justify-between">
                                <span>SIMULATION DOVX</span>
                                <span>{marketPrices.DOVX.toFixed(3)}</span>
                            </span>
                            <input 
                                type="range" 
                                min="0" max="2" step="0.001"
                                value={marketPrices.DOVX}
                                onChange={handleSimulationSlider}
                                className="accent-blue-500"
                            />
                            <div className="flex justify-between text-[8px] text-slate-500 mt-1">
                                <span>0</span>
                                <span>1</span>
                                <span>2 WAX</span>
                            </div>
                        </div>

                        {/* TU MANUAL */}
                        <div className="flex flex-col">
                            <span className="text-xs text-slate-400 mb-1">Ressources (WAX)</span>
                            <input 
                            type="number" 
                            step="0.000001"
                            value={marketPrices.DOVF}
                            onChange={(e) => handleManualTuChange(e.target.value)}
                            className="bg-slate-700 text-blue-400 w-24 px-2 py-1 rounded border border-slate-600 focus:outline-none focus:border-blue-500"
                            />
                        </div>
                    </div>
                </header>

                {/* NAVIGATION */}
                <div className="flex gap-4 mb-6 overflow-x-auto pb-2">
                    <button 
                    onClick={() => setActiveTab('combat')}
                    className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all whitespace-nowrap ${activeTab === 'combat' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                    >
                    <Crosshair size={18} /> simulateur COMBAT
                    </button>
                    <button 
                    onClick={() => setActiveTab('production')}
                    className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all whitespace-nowrap ${activeTab === 'production' ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                    >
                    <FactoryIcon size={18} /> analyse PRODUCTION
                    </button>
                    <button 
                    onClick={() => setActiveTab('packs')}
                    className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all whitespace-nowrap ${activeTab === 'packs' ? 'bg-purple-600 text-white shadow-lg shadow-purple-900/50' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                    >
                    <Package size={18} /> créateur de PACK
                    </button>
                </div>

                {/* --- TAB: COMBAT SIMULATOR --- */}
                {activeTab === 'combat' && (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    {/* COL 1: SELECTOR */}
                    <div className="space-y-6">
                        <Card className="max-h-[600px] overflow-y-auto">
                        <h3 className="text-lg font-bold text-blue-300 mb-4 flex items-center gap-2 sticky top-0 bg-slate-800 py-2 z-10 border-b border-slate-700">
                            <Crosshair size={20} /> Sélection Zone
                        </h3>
                        <div className="space-y-2">
                            {ZONES.map(zone => {
                            const isLocked = zone.keyReq > 0 && !userInventory.keys.some(k => k.order >= zone.keyReq);
                            return (
                                <button
                                key={zone.id}
                                onClick={() => setSelectedZoneId(zone.id)}
                                className={`w-full text-left px-3 py-2 rounded border transition-all flex justify-between items-center text-sm ${
                                    selectedZoneId === zone.id 
                                    ? 'bg-blue-900/40 border-blue-500 text-white' 
                                    : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'
                                }`}
                                >
                                <div className="flex items-center gap-2">
                                    {isLocked ? <Lock size={12} className="text-red-500" /> : <ChevronRight size={12} className="text-emerald-500" />}
                                    <div>
                                    <div className="font-bold">{zone.name}</div>
                                    <div className="text-[10px] uppercase opacity-70 tracking-wide">{zone.type}</div>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-[10px] text-slate-500">Win Reward</div>
                                    <div className="font-mono font-bold text-yellow-500">{zone.win}</div>
                                </div>
                                </button>
                            );
                            })}
                        </div>
                        </Card>

                        <Card>
                        <h3 className="text-lg font-bold text-yellow-300 mb-4 flex items-center gap-2">
                            <Users size={20} /> État Major
                        </h3>
                        
                        <div className="mb-4">
                            <label className="text-xs text-slate-400 uppercase font-bold mb-1 block">Officier (Gatekeeper)</label>
                            <select 
                            className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:outline-none focus:border-blue-500"
                            onChange={(e) => setSelectedOfficer(userInventory.officers.find(o => o.id === e.target.value))}
                            >
                            <option value="">-- Choisir Officier --</option>
                            {userInventory.officers.map(off => (
                                <option key={off.id} value={off.id}>{off.name} (Lvl {off.order})</option>
                            ))}
                            </select>
                        </div>

                        <div>
                            <label className="text-xs text-slate-400 uppercase font-bold mb-1 block">Support (Bonus)</label>
                            <select 
                            className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:outline-none focus:border-blue-500"
                            onChange={(e) => setSelectedSupport(userInventory.supports.find(s => s.id === e.target.value))}
                            >
                            <option value="">-- Choisir Support --</option>
                            {userInventory.supports.map(sup => (
                                <option key={sup.id} value={sup.id}>{sup.name} (+{sup.bonusPct}%)</option>
                            ))}
                            </select>
                            {selectedSupport && (
                            <div className="mt-2 text-xs text-emerald-400 flex items-center gap-1">
                                <TrendingUp size={12} /> Bonus actif: +{selectedSupport.bonusPct}% sur le poids total
                            </div>
                            )}
                        </div>
                        </Card>
                    </div>

                    {/* COL 2: SQUAD BUILDER */}
                    <div className="space-y-6">
                        <Card className="h-full">
                        <h3 className="text-lg font-bold text-emerald-300 mb-4 flex items-center gap-2">
                            <Shield size={20} /> Constructeur d'Escouade
                        </h3>
                        
                        <div className="space-y-3 max-h-[600px] overflow-y-auto pr-2">
                            {userInventory.units.map(unit => {
                            const bonus = unit.bonuses[selectedZone.type] || 0;
                            const isEffective = bonus >= 1.0;
                            const isBad = bonus < 0.5;
                            const effectiveW = unit.baseWeight * bonus;
                            const isSelected = !!selectedSquad.find(u => u.id === unit.id);

                            return (
                                <div 
                                key={unit.id}
                                onClick={() => toggleUnit(unit)}
                                className={`p-3 rounded border cursor-pointer transition-all relative ${
                                    isSelected 
                                    ? 'bg-emerald-900/30 border-emerald-500' 
                                    : 'bg-slate-900 border-slate-700 hover:border-slate-500'
                                }`}
                                >
                                <div className="flex justify-between items-start">
                                    <div>
                                    <div className="font-bold text-sm">{unit.name}</div>
                                    <div className="text-xs text-slate-400">{unit.type}</div>
                                    </div>
                                    <div className="text-right">
                                    <div className={`font-mono font-bold ${isBad ? 'text-red-400' : isEffective ? 'text-emerald-400' : 'text-yellow-400'}`}>
                                        {effectiveW.toFixed(2)} pts
                                    </div>
                                    <div className="text-[10px] text-slate-500">
                                        Base: {unit.baseWeight} x {Math.round(bonus * 100)}%
                                    </div>
                                    </div>
                                </div>
                                
                                {isBad && (
                                    <div className="absolute top-1 right-1">
                                    <AlertTriangle size={12} className="text-red-500" />
                                    </div>
                                )}
                                </div>
                            );
                            })}
                        </div>
                        </Card>
                    </div>

                    {/* COL 3: RESULTS & ROI */}
                    <div className="space-y-6">
                        
                        {/* STATUS PANEL */}
                        <Card className="border-t-4 border-t-blue-500">
                        <h3 className="text-lg font-bold text-white mb-4">Analyse Tactique</h3>
                        
                        <div className="space-y-4">
                            <div className="flex justify-between items-center border-b border-slate-700 pb-2">
                            <span className="text-sm text-slate-400">Accès Zone (Key)</span>
                            {hasRequiredKey ? (
                                <Badge color="green">AUTORISÉ</Badge>
                            ) : (
                                <Badge color="red">VERROUILLÉ</Badge>
                            )}
                            </div>

                            <div className="flex justify-between items-center border-b border-slate-700 pb-2">
                            <span className="text-sm text-slate-400">Commandement</span>
                            {hasOfficer ? (
                                <Badge color="green">PRÊT</Badge>
                            ) : (
                                <Badge color="yellow">OFFICIER REQUIS</Badge>
                            )}
                            </div>

                            <div className="bg-slate-900 p-3 rounded border border-slate-700">
                            <div className="flex justify-between text-sm mb-1">
                                <span className="text-slate-400">Poids Requis (Win)</span>
                                <span className="font-mono text-white">{selectedZone.minWeight.toFixed(2)}</span>
                            </div>
                            <div className="flex justify-between text-lg font-bold mb-2">
                                <span className={squadStats.finalWeight >= selectedZone.minWeight ? "text-emerald-400" : "text-red-400"}>
                                Puissance Totale
                                </span>
                                <span className="font-mono text-white">{squadStats.finalWeight.toFixed(2)}</span>
                            </div>
                            
                            <div className="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                                <div 
                                className={`h-full ${squadStats.finalWeight >= selectedZone.minWeight ? 'bg-emerald-500' : 'bg-red-500'}`}
                                style={{ width: `${Math.min((squadStats.finalWeight / selectedZone.minWeight) * 100, 100)}%` }}
                                ></div>
                            </div>
                            <div className="mt-1 text-xs text-right text-slate-500">
                                Support Bonus: +{squadStats.supportBonus * 100}% inclus
                            </div>
                            </div>

                            <div className="mt-4 text-center">
                            {!hasRequiredKey ? (
                                <div className="p-3 bg-red-900/50 border border-red-500 rounded text-red-200 font-bold flex items-center justify-center gap-2">
                                <Lock size={18} /> CLÉ MANQUANTE
                                </div>
                            ) : squadStats.finalWeight >= selectedZone.minWeight ? (
                                <div className="p-3 bg-emerald-900/50 border border-emerald-500 rounded text-emerald-200 font-bold flex items-center justify-center gap-2">
                                <CheckCircle size={18} /> VICTOIRE ASSURÉE
                                </div>
                            ) : (
                                <div className="p-3 bg-red-900/50 border border-red-500 rounded text-red-200 font-bold flex items-center justify-center gap-2">
                                <AlertTriangle size={18} /> DÉFAITE PROBABLE
                                </div>
                            )}
                            </div>

                        </div>
                        </Card>

                        {/* FINANCIAL PANEL (ROI) */}
                        <Card className="border-t-4 border-t-yellow-500">
                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            <DollarSign size={20} /> Rentabilité / Combat
                        </h3>
                        
                        <div className="space-y-3 text-sm">
                            <div className="grid grid-cols-2 gap-4">
                            <div>
                                <span className="text-slate-400 text-xs block">COÛT RESSOURCES</span>
                                <div className="text-red-400 font-mono">-{combatROI.totalCostWAX.toFixed(2)} WAX</div>
                                <div className="text-red-500/70 text-xs font-mono">(-${combatROI.totalCostUsd.toFixed(3)})</div>
                            </div>
                            <div className="text-right">
                                <span className="text-slate-400 text-xs block">GAIN DOV-X</span>
                                <div className="text-emerald-400 font-mono">+{combatROI.rewardWAX.toFixed(2)} WAX</div>
                                <div className="text-emerald-500/70 text-xs font-mono">(+${combatROI.rewardUsd.toFixed(3)})</div>
                            </div>
                            </div>

                            <div className="border-t border-slate-700 pt-2">
                            <div className="flex justify-between items-baseline mb-1">
                                <span className="font-bold text-slate-300">Profit Net</span>
                                <span className={`text-lg font-bold ${combatROI.profitWAX > 0 ? "text-emerald-400" : "text-red-400"}`}>
                                {combatROI.profitWAX > 0 ? "+" : ""}{combatROI.profitWAX.toFixed(2)} WAX
                                </span>
                            </div>
                            <div className={`text-right font-mono text-sm ${combatROI.profitUsd > 0 ? "text-emerald-500" : "text-red-500"}`}>
                                {combatROI.profitUsd > 0 ? "+" : ""}${combatROI.profitUsd.toFixed(4)}
                            </div>
                            </div>

                            {/* Monthly Projection */}
                            <div className="border-t border-slate-700 pt-2 mt-2 bg-slate-900/50 p-2 rounded">
                                <div className="flex justify-between items-center mb-1">
                                    <span className="text-xs text-slate-400 flex items-center gap-1"><Calendar size={12}/> Projection Mensuelle (x30)</span>
                                </div>
                                <div className={`text-right font-bold text-sm ${combatROI.monthlyProfitUsd > 0 ? "text-emerald-400" : "text-red-400"}`}>
                                    {combatROI.monthlyProfitUsd > 0 ? "+" : ""}${combatROI.monthlyProfitUsd.toFixed(2)}
                                </div>
                            </div>

                            <div className="text-center bg-slate-900 rounded p-1 text-xs text-slate-500 mt-1">
                            ROI: <span className={combatROI.roiPercent > 0 ? "text-green-400" : "text-slate-500"}>{combatROI.roiPercent}%</span>
                            </div>
                        </div>
                        </Card>
                    </div>
                    </div>
                )}

                {/* --- TAB: PRODUCTION ANALYSIS --- */}
                {activeTab === 'production' && (
                    <div className="space-y-6">
                    <Card>
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h2 className="text-xl font-bold flex items-center gap-2 text-emerald-400">
                            <FactoryIcon /> Analyse Rentabilité Usines
                            </h2>
                            <p className="text-slate-400 text-sm mt-1">
                            Comparez le coût de production vs prix d'achat Alcor.
                            </p>
                        </div>
                        
                        <div className="flex items-center gap-4">
                            {/* TIMEFRAME TOGGLE */}
                            <div className="flex items-center gap-2 bg-slate-900 p-1 rounded-lg border border-slate-700">
                                <button
                                    onClick={() => setTimeframe('day')}
                                    className={`px-3 py-1 rounded text-xs font-bold transition-all ${timeframe === 'day' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}
                                >
                                    24H
                                </button>
                                <button
                                    onClick={() => setTimeframe('month')}
                                    className={`px-3 py-1 rounded text-xs font-bold transition-all ${timeframe === 'month' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}
                                >
                                    30 JOURS
                                </button>
                            </div>

                            {/* FILTER */}
                            <div className="flex items-center gap-2 bg-slate-900 p-1 rounded-lg border border-slate-700 hidden md:flex">
                                <Filter size={14} className="text-slate-500 ml-2" />
                                {['ALL', 'FUEL', 'REPAIR', 'SUPPLY', 'HEALTH'].map(f => (
                                <button
                                    key={f}
                                    onClick={() => setFactoryFilter(f)}
                                    className={`px-3 py-1 rounded text-xs font-bold transition-all ${factoryFilter === f ? 'bg-emerald-600 text-white' : 'text-slate-400 hover:text-white'}`}
                                >
                                    {f}
                                </button>
                                ))}
                            </div>
                        </div>
                        </div>

                        <div className="overflow-x-auto max-h-[700px]">
                        <table className="w-full text-left border-collapse">
                            <thead className="sticky top-0 bg-slate-800 z-10 shadow-lg">
                            <tr className="text-slate-400 border-b border-slate-700 text-xs uppercase">
                                <th className="p-3">Usine</th>
                                <th className="p-3">Type</th>
                                <th className="p-3">Rareté</th>
                                <th className="p-3 text-right">Prod/{timeframe === 'day' ? '24h' : 'Mois'}</th>
                                <th className="p-3 text-right">Coût Unit (WAX)</th>
                                <th className="p-3 text-right text-emerald-300">Profit {timeframe === 'day' ? '24h' : '30j'} ($)</th>
                                <th className="p-3 text-center">Action</th>
                            </tr>
                            </thead>
                            <tbody className="overflow-y-auto">
                            {filteredFactories.map(factory => (
                                <tr key={factory.id} className="border-b border-slate-700 hover:bg-slate-700/30 transition-colors">
                                <td className="p-3 font-bold text-white text-sm">{factory.name}</td>
                                <td className="p-3 text-xs text-slate-400">{factory.type}</td>
                                <td className="p-3">
                                    <Badge color={factory.rarity === 'Legendary' ? 'yellow' : factory.rarity === 'Epic' ? 'purple' : factory.rarity === 'Supreme' ? 'red' : 'blue'}>
                                    {factory.rarity} {factory.level < 5 ? `L${factory.level}` : ''}
                                    </Badge>
                                </td>
                                <td className="p-3 text-right font-mono text-emerald-400 text-sm">
                                    {factory.displayOutput.toLocaleString(undefined, {maximumFractionDigits: 0})}
                                </td>
                                
                                <td className="p-3 text-right font-mono text-sm">
                                    <div className={factory.betterToBuy ? "text-red-300" : "text-slate-300"}>
                                    {factory.unitCost.toFixed(6)}
                                    </div>
                                    <div className="text-[10px] text-slate-500">Mkt: {factory.marketPrice.toFixed(6)}</div>
                                </td>
                                
                                <td className="p-3 text-right font-mono text-sm font-bold">
                                    <div className={factory.displayProfitUsd > 0 ? "text-emerald-400" : "text-red-400"}>
                                    ${factory.displayProfitUsd.toFixed(timeframe === 'day' ? 4 : 2)}
                                    </div>
                                    <div className="text-[10px] text-slate-500">{factory.displayProfitWax.toFixed(2)} WAX</div>
                                </td>
                                
                                <td className="p-3 text-center">
                                    {factory.betterToBuy ? (
                                    <div className="inline-flex items-center gap-1 text-red-400 font-bold bg-red-900/30 px-2 py-1 rounded text-xs">
                                        <AlertTriangle size={12} /> BUY
                                    </div>
                                    ) : (
                                    <div className="inline-flex items-center gap-1 text-emerald-400 font-bold bg-emerald-900/30 px-2 py-1 rounded text-xs">
                                        <CheckCircle size={12} /> PROD
                                    </div>
                                    )}
                                </td>
                                </tr>
                            ))}
                            </tbody>
                        </table>
                        </div>
                    </Card>
                    </div>
                )}

                {/* --- TAB: PACK BUILDER --- */}
                {activeTab === 'packs' && (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        
                        {/* COLUMN 1: BUILDER */}
                        <div className="space-y-6">
                            <Card>
                                <h3 className="text-lg font-bold text-purple-300 mb-4 flex items-center gap-2">
                                    <Package size={20} /> Configuration du Pack
                                </h3>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs text-slate-400 block mb-1">Nom du Pack</label>
                                        <input 
                                            type="text" 
                                            value={packBuilder.name}
                                            onChange={(e) => setPackBuilder({...packBuilder, name: e.target.value})}
                                            className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm focus:border-purple-500 outline-none"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="text-xs text-slate-400 block mb-1">Prix d'Achat (WAX)</label>
                                        <div className="relative">
                                            <input 
                                                type="number" 
                                                value={packBuilder.price}
                                                onChange={(e) => setPackBuilder({...packBuilder, price: parseFloat(e.target.value)})}
                                                className="w-full bg-slate-900 border border-slate-600 rounded p-2 pl-2 text-sm text-yellow-400 font-mono font-bold focus:border-purple-500 outline-none"
                                            />
                                            <span className="absolute right-3 top-2 text-xs text-slate-500">WAX</span>
                                        </div>
                                    </div>

                                    {/* CALCUL PRIX VIA ROI */}
                                    <div className="flex items-center gap-2 mt-2">
                                        <div className="flex-1">
                                            <label className="text-xs text-slate-400 block mb-1">Ou calculer prix via ROI (Jours)</label>
                                            <div className="relative">
                                                <input 
                                                    type="number" 
                                                    placeholder="Ex: 30"
                                                    value={targetRoi}
                                                    onChange={(e) => updatePriceFromRoi(e.target.value)}
                                                    className="w-full bg-slate-800 border border-purple-500/50 rounded p-2 pl-8 text-sm text-purple-300 focus:border-purple-500 outline-none"
                                                />
                                                <div className="absolute left-2 top-2 text-purple-500">
                                                    <Calculator size={16}/>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex-1">
                                            <label className="text-xs text-slate-400 block mb-1">Prix conseillé ($)</label>
                                            <div className="p-2 text-sm font-bold text-white bg-slate-800 border border-slate-600 rounded">
                                                ${(packBuilder.price * waxPriceUsd).toFixed(2)}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="border-t border-slate-700 pt-4">
                                        <label className="text-xs text-slate-400 block mb-2">Ajouter un Bâtiment</label>
                                        <div className="flex gap-2">
                                            <select 
                                                className="flex-1 bg-slate-900 border border-slate-600 rounded p-2 text-sm outline-none"
                                                value={selectedFactoryToAdd}
                                                onChange={(e) => setSelectedFactoryToAdd(e.target.value)}
                                            >
                                                {FACTORIES.map(f => (
                                                    <option key={f.id} value={f.id}>{f.name} (Prod: {f.output * 24}/j)</option>
                                                ))}
                                            </select>
                                            <button 
                                                onClick={addToPack}
                                                className="bg-purple-600 hover:bg-purple-500 text-white p-2 rounded"
                                            >
                                                <Plus size={20} />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </Card>

                            <Card className="min-h-[200px]">
                                <h3 className="text-sm font-bold text-slate-400 mb-2 uppercase">Contenu du Pack</h3>
                                {packBuilder.contents.length === 0 ? (
                                    <div className="text-slate-500 text-center py-8 text-sm italic">
                                        Aucun bâtiment ajouté.
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        {packBuilder.contents.map((item, idx) => {
                                            const factory = FACTORIES.find(f => f.id === item.factoryId);
                                            return (
                                                <div key={idx} className="flex justify-between items-center bg-slate-900 p-2 rounded border border-slate-700">
                                                    <div className="flex-1">
                                                        <div className="text-sm font-bold">{factory.name}</div>
                                                        <div className="text-xs text-slate-500 flex gap-2">
                                                            <span>{factory.rarity}</span>
                                                            <span className="text-slate-600">|</span>
                                                            <span>{factory.type}</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <input 
                                                            type="number" 
                                                            min="1"
                                                            value={item.qty}
                                                            onChange={(e) => updatePackQty(item.factoryId, e.target.value)}
                                                            className="w-12 bg-slate-800 border border-slate-600 rounded p-1 text-center text-sm"
                                                        />
                                                        <button 
                                                            onClick={() => removeFromPack(item.factoryId)}
                                                            className="text-red-500 hover:text-red-400"
                                                        >
                                                            <Trash2 size={16} />
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </Card>
                        </div>

                        {/* COLUMN 2: ANALYSIS */}
                        <div className="space-y-6">
                            <Card className="border-t-4 border-t-purple-500 h-full flex flex-col justify-between">
                                <div>
                                    <h3 className="text-lg font-bold text-white mb-6">Analyse de Rentabilité</h3>
                                    
                                    <div className="space-y-4 mb-8">
                                        <div className="flex justify-between items-center text-sm border-b border-slate-700 pb-2">
                                            <span className="text-slate-400">Investissement</span>
                                            <span className="font-mono text-yellow-400 text-lg font-bold">{packBuilder.price} WAX</span>
                                        </div>

                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <div className="text-xs text-slate-500 mb-1">Production Brute / Jour</div>
                                                <div className="text-emerald-400 font-mono font-bold">
                                                    {packStats.totalDailyProdWax.toFixed(4)} WAX
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-xs text-slate-500 mb-1">Coût Maintenance / Jour</div>
                                                <div className="text-red-400 font-mono font-bold">
                                                    {packStats.totalDailyCostWax.toFixed(4)} WAX
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-slate-900 p-4 rounded border border-slate-700">
                                            <div className="text-center text-sm text-slate-400 mb-1">Profit Net Quotidien</div>
                                            <div className={`text-center text-2xl font-bold font-mono ${packStats.dailyNetWax > 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                {packStats.dailyNetWax > 0 ? '+' : ''}{packStats.dailyNetWax.toFixed(4)} WAX
                                            </div>
                                            <div className="text-center text-xs text-slate-500 mt-1">
                                                ≈ ${(packStats.dailyNetWax * waxPriceUsd).toFixed(4)} / jour
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gradient-to-r from-slate-800 to-slate-900 p-6 rounded-lg border border-slate-600 text-center">
                                    <div className="text-sm font-bold text-purple-300 uppercase tracking-wider mb-2">Retour sur Investissement</div>
                                    {packStats.dailyNetWax > 0 ? (
                                        <div>
                                            <div className="text-4xl font-bold text-white mb-1">
                                                {packStats.roiDays < 1 ? "< 1" : Math.ceil(packStats.roiDays)} <span className="text-lg font-normal text-slate-400">Jours</span>
                                            </div>
                                            <div className="text-xs text-slate-500">Pour récupérer vos {packBuilder.price} WAX</div>
                                        </div>
                                    ) : (
                                        <div className="text-red-400 font-bold flex flex-col items-center gap-2">
                                            <AlertTriangle size={32} />
                                            <span>JAMAIS RENTABLE</span>
                                            <span className="text-xs font-normal text-slate-400">Les coûts de maintenance dépassent la production.</span>
                                        </div>
                                    )}
                                </div>
                            </Card>
                        </div>

                    </div>
                )}

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DoVManager />);
    </script>
</body>
</html>
